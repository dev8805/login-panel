<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel POS WhatsApp</title>

    <link rel="icon" href="/icono-192x192.png">
    <link rel="apple-touch-icon" href="/icono-180x180.png">
    <link rel="manifest" href="/manifest.json">


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .form-row-ingrediente {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            align-items: stretch;
        }

        /* Versi√≥n tablet y desktop */
        @media (min-width: 768px) {
            .form-row-ingrediente {
                grid-template-columns: 2fr 1fr 1fr auto;
                gap: 10px;
                align-items: end;
            }
        }

        .empty-receta {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .badge-procesado {
            display: inline-block;
            padding: 4px 8px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .date-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-selector button {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
        }

        #inputMensajeChat {
            padding: 4px 8px !important;
        }

        #inputMensajeChat:focus {
            outline: none !important;
        }

        .seccion-ingredientes {
            margin-top: 6px;
            padding-top: 4px;
            border-top: 1px solid #d0d0d0;
            font-size: 12px;
            color: #666;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 12px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-8px);
            }
        }

        /* Estilos para Modal de Mesas - Dise√±o Professional */

        /* Fondo del modal completo */
        #modalMesas {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        #modalMesas .modal-content {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            box-shadow: none;
        }

        #modalMesas .modal-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        /* Vista Desktop */
        .mesa-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: all 0.3s;
            min-width: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .mesa-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .mesa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mesa-title-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .mesa-title-input {
            font-size: 22px;
            font-weight: bold;
            color: #f1f5f9;
            border: none;
            background: transparent;
            outline: none;
            padding: 0;
            flex: 1;
        }

        .mesa-title-input:hover,
        .mesa-title-input:focus {
            color: #60a5fa;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .expand-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 8px;
            background: rgba(148, 163, 184, 0.1);
            color: #cbd5e1;
            border: 1px solid rgba(148, 163, 184, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            padding: 0;
        }

        .expand-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .expand-icon {
            width: 18px;
            height: 18px;
            stroke-width: 2.5;
            transition: transform 0.3s;
        }

        .close-mesa-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            padding: 0;
        }

        .close-mesa-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            transform: scale(1.05);
        }

        .close-icon {
            width: 18px;
            height: 18px;
            stroke-width: 3;
        }

        .productos-container-mesa {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .productos-wrapper-mesa {
            overflow-y: auto;
            margin-bottom: 15px;
            transition: max-height 0.3s ease;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
            padding: 8px;
        }

        .productos-wrapper-mesa.size-default {
            max-height: 240px;
        }

        .productos-wrapper-mesa.size-expanded {
            max-height: 560px;
        }

        .productos-wrapper-mesa::-webkit-scrollbar {
            width: 6px;
        }

        .productos-wrapper-mesa::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }

        .productos-wrapper-mesa::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        .productos-wrapper-mesa::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .productos-table-mesa {
            width: 100%;
            border-collapse: collapse;
        }

        .producto-row-mesa {
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .producto-row-mesa:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .producto-row-mesa td {
            padding: 10px 6px;
            font-size: 12px;
            vertical-align: middle;
            color: #cbd5e1;
        }

        .producto-row-mesa td:first-child {
            width: 90px;
        }

        .producto-row-mesa td:nth-child(2) {
            width: 45px;
        }

        .producto-row-mesa td:nth-child(3) {
            max-width: 150px;
            line-height: 1.4;
            color: #f1f5f9;
        }

        .producto-row-mesa td:nth-child(4) {
            width: 75px;
            font-weight: 600;
            color: #60a5fa;
        }

        .producto-row-mesa td:last-child {
            width: 45px;
            text-align: center;
        }

        .cantidad-control-mesa {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cantidad-btn-mesa {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border-radius: 50%;
            border: 2px solid #475569;
            background: rgba(71, 85, 105, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: bold;
            color: #cbd5e1;
            flex-shrink: 0;
            line-height: 1;
            transition: all 0.2s;
        }

        .cantidad-btn-mesa:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            color: #60a5fa;
            transform: scale(1.05);
        }

        .cantidad-display-mesa {
            min-width: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: #f1f5f9;
        }

        .delete-producto-mesa-btn {
            width: 38px;
            height: 26px;
            min-width: 38px;
            border-radius: 6px;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .delete-producto-mesa-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            transform: scale(1.05);
        }

        .trash-icon-mesa {
            width: 15px;
            height: 15px;
            color: #f87171;
        }

        .total-section-mesa {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            font-size: 16px;
            font-weight: bold;
            color: #cbd5e1;
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
        }

        .total-amount-mesa {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .buscar-section-mesa {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }

        .cantidad-buscar-mesa {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .buscar-input-mesa {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            font-size: 13px;
            min-width: 0;
            background: rgba(15, 23, 42, 0.4);
            color: #f1f5f9;
        }

        .buscar-input-mesa::placeholder {
            color: #64748b;
        }

        .buscar-input-mesa:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .mic-btn-mesa {
            width: 38px;
            height: 38px;
            min-width: 38px;
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            cursor: pointer;
            font-size: 16px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #60a5fa;
            transition: all 0.3s;
        }

        .mic-btn-mesa:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: #3b82f6;
        }

        .mic-btn-mesa.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: #ef4444;
            animation: pulse-recording 1.5s infinite;
        }

        @keyframes pulse-recording {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

        .registrar-venta-mesa-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .registrar-venta-mesa-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .mesas-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .mesas-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .add-mesa-card {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.05);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 350px;
        }

        .add-mesa-card:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .add-icon-mesa {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            color: #3b82f6;
            font-weight: 300;
            line-height: 1;
            background: rgba(59, 130, 246, 0.1);
        }

        /* Vista Mobile - Redise√±o Profesional */
        @media (max-width: 767px) {
            .mesas-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
                padding: 16px;
                max-height: none;
                background: transparent;
            }

            .mesa-card {
                padding: 18px;
                min-height: 85px;
                border-radius: 14px;
                border: 2px solid;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                gap: 10px;
                position: relative;
                overflow: hidden;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            }

            /* Mesa Disponible - Azul Professional */
            .mesa-card.disponible {
                border-color: rgba(59, 130, 246, 0.4);
                background: linear-gradient(135deg, rgba(30, 64, 175, 0.15) 0%, rgba(37, 99, 235, 0.2) 100%);
            }

            .mesa-card.disponible:active {
                background: linear-gradient(135deg, rgba(30, 64, 175, 0.25) 0%, rgba(37, 99, 235, 0.3) 100%);
                border-color: #3b82f6;
                transform: scale(0.98);
                box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            }

            /* Mesa Ocupada - Verde √âxito */
            .mesa-card.ocupada {
                border-color: rgba(34, 197, 94, 0.5);
                background: linear-gradient(135deg, rgba(21, 128, 61, 0.2) 0%, rgba(22, 163, 74, 0.25) 100%);
                box-shadow: 0 2px 16px rgba(34, 197, 94, 0.25),
                    0 0 30px rgba(34, 197, 94, 0.15);
            }

            .mesa-card.ocupada:active {
                background: linear-gradient(135deg, rgba(21, 128, 61, 0.3) 0%, rgba(22, 163, 74, 0.35) 100%);
                border-color: #22c55e;
                transform: scale(0.98);
                box-shadow: 0 4px 24px rgba(34, 197, 94, 0.4),
                    0 0 35px rgba(34, 197, 94, 0.2);
            }

            /* Header: Nombre + Estado */
            .mesa-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0;
                gap: 10px;
            }

            .mesa-title-wrapper {
                flex: 1;
            }

            .mesa-title-input {
                font-size: 17px;
                font-weight: 700;
                color: #f1f5f9;
                background: transparent;
                border: none;
                padding: 0;
                cursor: pointer;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }

            /* Badge de estado */
            .mesa-estado-badge {
                padding: 5px 12px;
                border-radius: 16px;
                font-size: 10px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                white-space: nowrap;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }

            .mesa-card.disponible .mesa-estado-badge {
                background: rgba(59, 130, 246, 0.25);
                color: #93c5fd;
                border: 1px solid rgba(59, 130, 246, 0.4);
            }

            .mesa-card.ocupada .mesa-estado-badge {
                background: rgba(34, 197, 94, 0.3);
                color: #86efac;
                border: 1px solid rgba(34, 197, 94, 0.5);
            }

            /* Total Badge */
            .mesa-info-mobile {
                display: flex;
                align-items: center;
            }

            .mesa-total-badge {
                padding: 8px 16px;
                border-radius: 10px;
                font-weight: 800;
                font-size: 20px;
                letter-spacing: -0.5px;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
            }

            .mesa-card.disponible .mesa-total-badge {
                background: rgba(30, 64, 175, 0.3);
                color: #93c5fd;
                border: 2px solid rgba(59, 130, 246, 0.4);
                text-shadow: 0 0 12px rgba(147, 197, 253, 0.4);
            }

            .mesa-card.ocupada .mesa-total-badge {
                background: rgba(21, 128, 61, 0.35);
                color: #86efac;
                border: 2px solid rgba(34, 197, 94, 0.5);
                text-shadow: 0 0 15px rgba(134, 239, 172, 0.5);
                animation: pulse-total 2.5s ease-in-out infinite;
            }

            @keyframes pulse-total {

                0%,
                100% {
                    box-shadow: 0 3px 12px rgba(34, 197, 94, 0.25);
                }

                50% {
                    box-shadow: 0 3px 18px rgba(34, 197, 94, 0.4), 0 0 25px rgba(34, 197, 94, 0.3);
                }
            }

            .header-actions,
            .productos-container-mesa,
            .total-section-mesa,
            .buscar-section-mesa,
            .registrar-venta-mesa-btn {
                display: none;
            }

            /* Resumen Total */
            .resumen-mesas-mobile {
                background: linear-gradient(135deg, rgba(21, 128, 61, 0.2) 0%, rgba(22, 163, 74, 0.25) 100%);
                border: 2px solid rgba(34, 197, 94, 0.4);
                border-radius: 14px;
                padding: 20px;
                margin-top: 8px;
                text-align: center;
                box-shadow: 0 4px 20px rgba(34, 197, 94, 0.2);
                position: relative;
                overflow: hidden;
            }

            .resumen-mesas-mobile::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(34, 197, 94, 0.15) 0%, transparent 70%);
                animation: rotate-gradient 5s linear infinite;
            }

            @keyframes rotate-gradient {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            .resumen-mesas-mobile .label {
                font-size: 10px;
                color: #86efac;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                font-weight: 700;
                margin-bottom: 10px;
                position: relative;
                z-index: 1;
            }

            .resumen-mesas-mobile .total {
                font-size: 30px;
                font-weight: 800;
                color: #86efac;
                text-shadow: 0 0 20px rgba(134, 239, 172, 0.5);
                letter-spacing: -0.5px;
                position: relative;
                z-index: 1;
            }

            /* Bot√≥n Agregar Mesa */
            .add-mesa-card {
                min-height: 70px;
                border-radius: 14px;
                background: rgba(59, 130, 246, 0.08);
                border: 2px dashed rgba(59, 130, 246, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            }

            .add-mesa-card:active {
                background: rgba(59, 130, 246, 0.15);
                border-color: #3b82f6;
                transform: scale(0.97);
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            }

            .add-icon-mesa {
                width: 42px;
                height: 42px;
                border-radius: 50%;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                font-weight: 400;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                transition: all 0.3s ease;
            }

            .add-mesa-card:active .add-icon-mesa {
                transform: rotate(90deg) scale(0.9);
            }
        }

        .registrar-venta-mesa-btn {
            width: 100%;
            padding: 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .registrar-venta-mesa-btn:hover {
            background: #059669;
        }

        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .mesas-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .mesas-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Vista mobile de mesas */
        @media (max-width: 767px) {
            .mesas-grid {
                display: flex;
                flex-direction: column;
                gap: 16px;
                padding: 20px 16px;
                max-height: none;
            }

            .mesa-card {
                padding: 20px;
                min-height: 80px;
                border-radius: 16px;
                border: 2px solid;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                gap: 12px;
                position: relative;
                overflow: hidden;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Efecto de brillo en el fondo */
            .mesa-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                transition: left 0.5s;
            }

            .mesa-card:active::before {
                left: 100%;
            }

            /* Mesa Disponible - Cyan elegante */
            .mesa-card.disponible {
                border-color: rgba(0, 212, 255, 0.4);
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.05) 0%, rgba(0, 180, 216, 0.08) 100%);
                box-shadow: 0 4px 12px rgba(0, 212, 255, 0.08);
            }

            .mesa-card.disponible:active {
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.12) 0%, rgba(0, 180, 216, 0.15) 100%);
                border-color: #00d4ff;
                transform: scale(0.98);
                box-shadow: 0 2px 8px rgba(0, 212, 255, 0.2);
            }

            /* Mesa Ocupada - Verde vibrante con glow */
            .mesa-card.ocupada {
                border-color: rgba(16, 185, 129, 0.6);
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(5, 150, 105, 0.15) 100%);
                box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2),
                    0 0 20px rgba(16, 185, 129, 0.1);
            }

            .mesa-card.ocupada:active {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.18) 0%, rgba(5, 150, 105, 0.22) 100%);
                border-color: #10b981;
                transform: scale(0.98);
                box-shadow: 0 2px 12px rgba(16, 185, 129, 0.3),
                    0 0 25px rgba(16, 185, 129, 0.15);
            }

            /* Row superior: Nombre + Estado */
            .mesa-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0;
                gap: 12px;
            }

            .mesa-title-wrapper {
                flex: 1;
            }

            .mesa-title-input {
                font-size: 18px;
                font-weight: 700;
                color: white;
                background: transparent;
                border: none;
                padding: 0;
                cursor: pointer;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            /* Badge de estado - m√°s peque√±o y elegante */
            .mesa-estado-badge {
                padding: 6px 14px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                white-space: nowrap;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .mesa-card.disponible .mesa-estado-badge {
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.25) 0%, rgba(0, 180, 216, 0.35) 100%);
                color: #00d4ff;
                border: 1px solid rgba(0, 212, 255, 0.4);
            }

            .mesa-card.ocupada .mesa-estado-badge {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.4) 100%);
                color: #10b981;
                border: 1px solid rgba(16, 185, 129, 0.5);
            }

            /* Total - Badge grande y prominente */
            .mesa-info-mobile {
                display: flex;
                align-items: center;
                gap: 0;
            }

            .mesa-total-badge {
                padding: 10px 18px;
                border-radius: 12px;
                font-weight: 800;
                font-size: 22px;
                letter-spacing: -0.5px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
                position: relative;
            }

            .mesa-card.disponible .mesa-total-badge {
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 180, 216, 0.25) 100%);
                color: #00d4ff;
                border: 2px solid rgba(0, 212, 255, 0.3);
                text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            }

            .mesa-card.ocupada .mesa-total-badge {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.25) 0%, rgba(5, 150, 105, 0.35) 100%);
                color: #10b981;
                border: 2px solid rgba(16, 185, 129, 0.5);
                text-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
                animation: pulse-glow 2s ease-in-out infinite;
            }

            @keyframes pulse-glow {

                0%,
                100% {
                    box-shadow: 0 3px 10px rgba(16, 185, 129, 0.15);
                }

                50% {
                    box-shadow: 0 3px 15px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.2);
                }
            }

            .header-actions,
            .productos-container-mesa,
            .total-section-mesa,
            .buscar-section-mesa,
            .registrar-venta-mesa-btn {
                display: none;
            }

            /* Resumen total - Dise√±o mejorado */
            .resumen-mesas-mobile {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.2) 100%);
                border: 2px solid rgba(16, 185, 129, 0.4);
                border-radius: 16px;
                padding: 24px 20px;
                margin-top: 8px;
                text-align: center;
                box-shadow: 0 4px 16px rgba(16, 185, 129, 0.15);
                position: relative;
                overflow: hidden;
            }

            .resumen-mesas-mobile::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
                animation: rotate-gradient 4s linear infinite;
            }

            @keyframes rotate-gradient {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            .resumen-mesas-mobile .label {
                font-size: 11px;
                color: rgba(16, 185, 129, 0.8);
                text-transform: uppercase;
                letter-spacing: 1.5px;
                font-weight: 700;
                margin-bottom: 12px;
                position: relative;
                z-index: 1;
            }

            .resumen-mesas-mobile .total {
                font-size: 32px;
                font-weight: 800;
                color: #10b981;
                text-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
                letter-spacing: -1px;
                position: relative;
                z-index: 1;
            }

            /* Bot√≥n agregar mesa - Dise√±o atractivo */
            .add-mesa-card {
                min-height: 70px;
                border-radius: 16px;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.12) 100%);
                border: 2px dashed rgba(102, 126, 234, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 16px;
                position: relative;
                overflow: hidden;
            }

            .add-mesa-card::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(102, 126, 234, 0.2);
                transform: translate(-50%, -50%);
                transition: width 0.4s, height 0.4s;
            }

            .add-mesa-card:active::before {
                width: 300px;
                height: 300px;
            }

            .add-mesa-card:active {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.2) 100%);
                border-color: #667eea;
                transform: scale(0.97);
            }

            .add-icon-mesa {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 26px;
                color: white;
                font-weight: 300;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                position: relative;
                z-index: 1;
                transition: all 0.3s ease;
            }

            .add-mesa-card:active .add-icon-mesa {
                transform: rotate(90deg) scale(0.9);
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            }
        }

        .add-mesa-card {
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 350px;
        }

        .add-mesa-card:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .add-icon-mesa {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            color: #333;
            font-weight: 300;
            line-height: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üì± POS WhatsApp</h1>
            <p>Panel de Administraci√≥n</p>
        </div>

        <div class="content">
            <!-- Loading -->
            <div id="loading" class="loading">
                Verificando sesi√≥n...
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="login-form" style="display: none;">
                <div id="errorMsg" class="error"></div>

                <div class="form-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email" id="email" placeholder="tu@email.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>

                <button id="loginBtn" onclick="login()">Iniciar Sesi√≥n</button>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="dashboard">
                <div class="user-info">
                    <h2 id="userName">Cargando...</h2>
                    <p id="userRole"></p>
                    <p id="businessName"></p>
                </div>

                <div class="menu-grid" id="menuGrid">
                    <!-- Se llenan din√°micamente -->
                </div>

                <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

    </div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://fqujxgwresrdvvfkmdgv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxdWp4Z3dyZXNyZHZ2ZmttZGd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDc2NzQsImV4cCI6MjA3MDA4MzY3NH0._XwIEgRXVzSYZI7Y6nNZ9jfmrjjIw6Dy1RTP7z0qKCI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('‚úÖ Supabase inicializado correctamente');

        let userData = null;

        let draggedItem = null;

        // Men√∫ de opciones con sus URLs
        const menuOptions = [
            {
                id: 'crear_producto',
                icon: 'üì¶',
                title: 'Crear Producto',
                url: '#',
                permission: 'productos.crear',
                modal: true
            },
            {
                id: 'registrar_compra',
                icon: 'üõí',
                title: 'Registrar Compra',
                url: '#',
                permission: 'inventario.modificar',
                modal: true
            },
            {
                id: 'crear_usuario',
                icon: 'üë§',
                title: 'Crear Usuario',
                url: '#',
                permission: 'usuarios.crear',
                modal: true
            },
            {
                id: 'informes',
                icon: 'üìä',
                title: 'Informes',
                url: '#',
                permission: 'informes.ver',
                modal: true
            },
            {
                id: 'editar_producto',
                icon: '‚úèÔ∏è',
                title: 'Editar Producto',
                url: '#',
                permission: 'productos.editar',
                modal: true
            },
            {
                id: 'editar_apodos',
                icon: 'üè∑Ô∏è',
                title: 'Editar Apodos',
                url: '#',
                permission: 'productos.editar',
                modal: true
            },
            {
                id: 'chat_asistente',
                icon: 'üí¨',
                title: 'Chat Asistente',
                url: '#',
                permission: 'informes.ver',
                modal: true
            },
            {
                id: 'mesas',
                icon: 'üçΩÔ∏è',
                title: 'Mesas',
                url: '#',
                permission: 'ventas.registrar',
                modal: true
            }
        ];

        // Verificar sesi√≥n al cargar
        async function checkSession() {
            try {
                console.log('üîç Verificando sesi√≥n...');
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) throw error;
                console.log('üìù Sesi√≥n encontrada:', session);
                if (session) {
                    await loadUserData(session.user.id);
                    showDashboard();
                } else {
                    console.log('‚ùå No hay sesi√≥n activa');
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking session:', error);
                showLogin();
            }
        }

        // Cargar datos dl usuario

        async function loadUserData(authUserId) {
            try {
                console.log('üë§ Cargando datos del usuario:', authUserId);

                // Usar RPC para evitar problemas con triggers/foreign keys
                const { data, error } = await supabase
                    .rpc('get_user_with_tenant', { p_user_id: authUserId });

                console.log('üì¶ Respuesta RPC:', data, error);

                if (error) throw error;
                if (!data) throw new Error('Usuario no encontrado');

                // Asignar a userData
                userData = {
                    user_id: data.user_id,
                    tenant_user_id: data.user_id,
                    nombre: data.nombre,
                    rol: data.rol,
                    permisos: data.permisos,
                    tenant_id: data.tenant_id,
                    telefono_whatsapp: data.telefono_whatsapp,
                    tenants: data.tenants
                };

                console.log('‚úÖ Usuario cargado correctamente:', userData);

            } catch (error) {
                console.error('‚ùå Error loading user:', error);
                showError('Error cargando datos del usuario: ' + error.message);
                await logout();
            }
        }


        // Login
        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                showError('Por favor completa todos los campos');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesi√≥n...';
            hideError();
            console.log('üîê Intentando login con:', email);
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;
                console.log('‚úÖ Login exitoso:', data);
                await loadUserData(data.user.id);
                showDashboard();

            } catch (error) {
                console.error('Login error:', error);
                showError(error.message || 'Error al iniciar sesi√≥n');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        // Logout
        async function logout() {
            try {
                await supabase.auth.signOut();
                userData = null;
                showLogin();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Mostrar login
        function showLogin() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Mostrar dashboard
        function showDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Actualizar info del usuario
            document.getElementById('userName').textContent = `üëã Hola, ${userData.nombre}`;
            document.getElementById('userRole').textContent = `Rol: ${userData.rol}`;
            document.getElementById('businessName').textContent = `üè™ ${userData.tenants.nombre_negocio}`;

            // Generar men√∫
            renderMenu();
        }
        // Renderizar men√∫ seg√∫n permisos
        function renderMenu() {
            const menuGrid = document.getElementById('menuGrid');
            menuGrid.innerHTML = '';

            const permisos = userData.permisos || {};

            // Cargar orden guardado o usar el orden por defecto
            const ordenGuardado = localStorage.getItem(`menu_orden_${userData.tenant_id}`);
            let opcionesOrdenadas = [...menuOptions];

            if (ordenGuardado) {
                const orden = JSON.parse(ordenGuardado);
                opcionesOrdenadas.sort((a, b) => {
                    const indexA = orden.indexOf(a.id);
                    const indexB = orden.indexOf(b.id);
                    return indexA - indexB;
                });
            }

            opcionesOrdenadas.forEach(option => {
                const hasPermission = checkPermission(permisos, option.permission);

                const menuItem = document.createElement('a');
                menuItem.className = `menu-item ${!hasPermission ? 'disabled' : ''}`;
                menuItem.dataset.optionId = option.id;

                if (hasPermission) {
                    menuItem.draggable = true;
                    configurarDragAndDrop(menuItem, option);
                }

                if (option.modal) {
                    menuItem.href = '#';
                    menuItem.onclick = (e) => {
                        e.preventDefault();
                        if (hasPermission) openModal(option.id);
                    };
                } else {
                    menuItem.href = hasPermission ? `${option.url}?auth=true` : '#';
                    menuItem.target = hasPermission ? '_blank' : '';
                }

                menuItem.innerHTML = `
            <div class="menu-item-icon">${option.icon}</div>
            <div class="menu-item-title">${option.title}</div>
        `;

                menuGrid.appendChild(menuItem);
            });
        }

        function configurarDragAndDrop(menuItem, option) {
            // Prevenir que el drag interfiera con el click
            let dragStarted = false;
            let startX, startY;

            menuItem.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                startY = e.clientY;
                dragStarted = false;
            });

            menuItem.addEventListener('dragstart', (e) => {
                dragStarted = true;
                draggedItem = menuItem;
                menuItem.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', menuItem.dataset.optionId);

                // Peque√±o delay para que no se confunda con el click
                setTimeout(() => {
                    menuItem.style.opacity = '0.4';
                }, 0);
            });

            menuItem.addEventListener('dragend', (e) => {
                menuItem.classList.remove('dragging');
                menuItem.style.opacity = '1';

                // Remover todos los indicadores
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('drag-over');
                });

                // Guardar el nuevo orden autom√°ticamente
                if (dragStarted) {
                    guardarOrdenAutomatico();
                }

                draggedItem = null;
                dragStarted = false;
            });

            menuItem.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                if (draggedItem && draggedItem !== menuItem) {
                    const menuGrid = document.getElementById('menuGrid');
                    const items = [...menuGrid.querySelectorAll('.menu-item:not(.dragging)')];
                    const afterElement = getDragAfterElement(menuGrid, e.clientX, e.clientY);

                    if (afterElement == null) {
                        menuGrid.appendChild(draggedItem);
                    } else {
                        menuGrid.insertBefore(draggedItem, afterElement);
                    }
                }
            });

            menuItem.addEventListener('dragenter', (e) => {
                if (draggedItem && draggedItem !== menuItem) {
                    menuItem.classList.add('drag-over');
                }
            });

            menuItem.addEventListener('dragleave', (e) => {
                menuItem.classList.remove('drag-over');
            });

            menuItem.addEventListener('drop', (e) => {
                e.preventDefault();
                menuItem.classList.remove('drag-over');
            });
        }

        function getDragAfterElement(container, x, y) {
            const draggableElements = [...container.querySelectorAll('.menu-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const centerX = box.left + box.width / 2;
                const centerY = box.top + box.height / 2;

                const offsetX = x - centerX;
                const offsetY = y - centerY;

                // Distancia euclidiana desde el cursor al centro del elemento
                const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);

                if (distance < closest.distance) {
                    // Determinar si insertar antes o despu√©s basado en la posici√≥n
                    const insertBefore = (offsetY < 0) || (offsetY === 0 && offsetX < 0);
                    return { distance: distance, element: insertBefore ? child : child.nextElementSibling };
                } else {
                    return closest;
                }
            }, { distance: Number.POSITIVE_INFINITY }).element;
        }

        function guardarOrdenAutomatico() {
            const menuGrid = document.getElementById('menuGrid');
            const items = menuGrid.querySelectorAll('.menu-item');
            const nuevoOrden = Array.from(items).map(item => item.dataset.optionId);

            // Guardar en localStorage
            localStorage.setItem(`menu_orden_${userData.tenant_id}`, JSON.stringify(nuevoOrden));

            console.log('‚úÖ Orden guardado autom√°ticamente');
        }

        // Verificar permiso
        function checkPermission(permisos, permissionPath) {
            // Due√±o tiene todos los permisos
            if (userData.rol === 'dueno') return true;

            const parts = permissionPath.split('.');
            let current = permisos;

            for (const part of parts) {
                if (!current || !current[part]) return false;
                current = current[part];
            }

            return current === true;
        }

        // Mostrar/ocultar error
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }

        // Enter para login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('email')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('password').focus();
            });

            document.getElementById('password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            checkSession();
        });
        // Abrir modal
        function openModal(modalId) {
            console.log('üîì Abriendo modal:', modalId);

            if (modalId === 'crear_producto') {
                const modal = document.getElementById('modalCrearProducto');
                const modalBody = document.getElementById('modalBody');

                // Cargar formulario
                modalBody.innerHTML = `
    <div id="successMsg" class="success-message"></div>
    <form id="formCrearProducto" onsubmit="submitProducto(event)">
        <div id="errorMsgModal" class="error"></div>
        
        <!-- Tipo de producto -->
        <div class="form-group">
            <label class="required">Tipo de producto</label>
            <div class="tipo-producto-group">
                <div class="tipo-producto-option selected" onclick="seleccionarTipoProducto('simple', this)">
                    <input type="radio" name="tipoProducto" id="tipoSimple" value="simple" checked>
                    <label for="tipoSimple">üì¶ Producto Simple</label>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">Se vende directamente</p>
                </div>
                
                <div class="tipo-producto-option" onclick="seleccionarTipoProducto('procesado', this)">
                    <input type="radio" name="tipoProducto" id="tipoProcesado" value="procesado">
                    <label for="tipoProcesado">üç¥ Producto Procesado</label>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">Tiene receta con ingredientes</p>
                </div>
            </div>
        </div>
                
        <div class="form-group">
            <label for="productoNombre">Nombre del producto *</label>
            <input type="text" id="productoNombre" required>
        </div>
        
        <div class="form-group">
            <label for="tipoVenta">Tipo de venta *</label>
            <select id="tipoVenta" required onchange="updateFormByType()">
                <option value="">Seleccionar...</option>
                <option value="unidad">Unidad</option>
                <option value="peso">Peso</option>
                <option value="medida">Medida</option>
            </select>
        </div>
        
        <div id="camposDinamicos"></div>
        
        <!-- Secci√≥n de Receta (solo para procesados) -->
        <div id="seccionReceta" class="receta-section">
            <h3 style="margin-bottom: 15px; color: #333;">üìù Receta del Producto</h3>
            
            <div class="alert alert-info" style="margin-bottom: 15px;">
                <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Define los ingredientes necesarios para producir 1 unidad de este producto.
            </div>
            
            <div id="listaIngredientes">
                <div class="empty-receta">
                    No hay ingredientes agregados a√∫n
                </div>
            </div>
            
            <div class="ingrediente-form">
                <h4 style="margin-bottom: 10px; color: #667eea;">Agregar Ingrediente</h4>
                <div class="form-row-ingrediente">
    <div>
        <label style="font-size: 13px; font-weight: 600; margin-bottom: 8px; display: block;">üì¶ Ingrediente</label>
        <select id="selectIngrediente">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 8px; display: block;">üî¢ Cantidad</label>
                        <input type="number" id="cantidadIngrediente" step="0.01" min="0.01" placeholder="50">
                    </div>
                    <div>
    <label style="font-size: 13px; font-weight: 600; margin-bottom: 8px; display: block;">‚öñÔ∏è Unidad</label>
    <select id="unidadIngrediente">
        <option value="">Selecciona ingrediente primero</option>
    </select>
</div>
                    <div>
        <label style="font-size: 13px; font-weight: 600; margin-bottom: 8px; display: block;">Acci√≥n</label>
        <button type="button" onclick="agregarIngredienteReceta()" style="background: #10b981; width: 100%; height: 48px; font-size: 16px; font-weight: 600;">
                            ‚ûï
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Apodos -->
        <div class="form-group">
            <label style="font-weight: 600;">Apodos del producto</label>
            
            <div id="listaApodosCrear" style="background: #fff; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; min-height: 60px;">
                <div id="apodosItemsCrear"></div>
            </div>
            
            <div style="background: #f5f7ff; padding: 15px; border-radius: 8px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">Agregar apodo</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input 
                        type="text" 
                        id="nuevoApodoCrear" 
                        placeholder="Escribe un apodo..."
                        style="flex: 1; padding: 10px 12px; max-width: 70%;"
                        onkeypress="if(event.key === 'Enter') { event.preventDefault(); agregarApodoCrear(); }"
                    >
                    <button 
                        type="button"
                        onclick="agregarApodoCrear()"
                        style="padding: 10px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; min-width: auto; width: auto; flex-shrink: 0;"
                    >
                        ‚ûï
                    </button>
                </div>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 8px;">El nombre del producto se agregar√° autom√°ticamente como apodo</small>
            </div>
        </div>
        
        <input type="hidden" id="apodos" value="">
        <input type="hidden" id="ingredientesReceta" value="">
        
        <button type="submit" id="btnSubmit">Crear Producto</button>
    </form>
    `;

                modal.classList.add('show');

                // Inicializar array de apodos y listener para nombre
                window.apodosCrearProducto = [];

                // Listener para cuando cambia el nombre del producto
                document.getElementById('productoNombre').addEventListener('blur', function () {
                    const nombreProducto = this.value.trim().toLowerCase();
                    if (nombreProducto && !window.apodosCrearProducto.includes(nombreProducto)) {
                        window.apodosCrearProducto.push(nombreProducto);
                        renderizarApodosCrear();
                    }
                });

            } else if (modalId === 'registrar_compra') {
                const modal = document.getElementById('modalRegistrarCompra');
                const modalBody = document.getElementById('modalBodyCompra');

                cargarFormularioCompra(modalBody);
                modal.classList.add('show');

            } else if (modalId === 'crear_usuario') {
                const modal = document.getElementById('modalCrearUsuario');
                const modalBody = document.getElementById('modalBodyUsuario');

                cargarFormularioUsuario(modalBody);
                modal.classList.add('show');
            } else if (modalId === 'informes') {
                const modal = document.getElementById('modalInformes');
                const modalBody = document.getElementById('modalBodyInformes');

                cargarInformes(modalBody);
                modal.classList.add('show');
            }

            else if (modalId === 'editar_producto') {
                const modal = document.getElementById('modalEditarProducto');
                const modalBody = document.getElementById('modalBodyEditarProducto');

                cargarFormularioEditarProducto(modalBody);
                modal.classList.add('show');
            } else if (modalId === 'editar_apodos') {
                const modal = document.getElementById('modalEditarApodos');
                const modalBody = document.getElementById('modalBodyEditarApodos');

                cargarFormularioEditarApodos(modalBody);
                modal.classList.add('show');
            }

            else if (modalId === 'chat_asistente') {
                abrirModalChat();
            }

            else if (modalId === 'mesas') {
                abrirModalMesas();
            }

        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('modalCrearProducto').classList.remove('show');
        }

        // Cerrar modal de compra
        function closeModalCompra() {
            document.getElementById('modalRegistrarCompra').classList.remove('show');
        }

        // Cerrar modal de usuario
        function closeModalUsuario() {
            document.getElementById('modalCrearUsuario').classList.remove('show');
        }

        // Cerrar modal de informes
        function closeModalInformes() {
            document.getElementById('modalInformes').classList.remove('show');
        }

        // Cerrar modal de editar producto
        function closeModalEditarProducto() {
            document.getElementById('modalEditarProducto').classList.remove('show');
        }

        // Funci√≥n para mostrar/ocultar campo de unidad personalizada
        function toggleUnidadCompraPersonalizada() {
            const select = document.getElementById('unidadCompra');
            const campoPersonalizado = document.getElementById('campoUnidadPersonalizada');
            const inputPersonalizado = document.getElementById('unidadCompraPersonalizada');

            if (select && campoPersonalizado) {
                if (select.value === 'OTRA') {
                    campoPersonalizado.style.display = 'block';
                    inputPersonalizado.required = true;
                } else {
                    campoPersonalizado.style.display = 'none';
                    inputPersonalizado.required = false;
                    inputPersonalizado.value = '';
                }
            }
        }

        // Cerrar modal de editar apodos
        function closeModalEditarApodos() {
            document.getElementById('modalEditarApodos').classList.remove('show');
        }

        // Cerrar modal de mesas
        function closeModalMesas() {
            document.getElementById('modalMesas').classList.remove('show');
            // Detener cualquier grabaci√≥n activa
            if (grabacionActivaMesas) {
                detenerGrabacionMesa(mesaGrabandoId);
            }
        }

        // Cargar formulario de usuario
        async function cargarFormularioUsuario(modalBody) {
            // Mostrar loading
            modalBody.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <p>Cargando formulario...</p>
        </div>
    `;

            try {
                // Cargar roles disponibles directamente de la tabla
                console.log('üîç Iniciando carga de roles...');

                const { data: roles, error: errorRoles } = await supabase
                    .from('roles_templates')
                    .select('*')
                    .order('rol');

                console.log('üìä Respuesta cruda de roles_templates:', roles);
                console.log('‚ùå Error en consulta:', errorRoles);

                if (errorRoles) {
                    console.error('‚ùå Error cargando roles:', errorRoles);
                    throw new Error('Error al cargar roles: ' + errorRoles.message);
                }

                console.log('üìã Roles cargados:', roles);

                // Verificar que todos los roles tengan permisos
                const rolesValidos = roles.filter(r => r.permisos && typeof r.permisos === 'object');
                console.log('üìã Roles cargados completos:', roles);
                console.log('üìã Roles v√°lidos con permisos:', rolesValidos);

                // Si no hay roles v√°lidos, intentar usar todos los roles disponibles
                const rolesAUsar = rolesValidos.length > 0 ? rolesValidos : roles;

                if (rolesAUsar.length === 0) {
                    throw new Error('No se encontraron roles en la base de datos');
                }

                console.log('üìã Roles a usar en el formulario:', rolesAUsar);

                // Determinar c√≥digo de pa√≠s seg√∫n zona horaria
                const zonaHoraria = userData.tenants.zona_horaria || 'America/Bogota';
                let codigoPais = '57'; // Por defecto Colombia (sin +)

                if (zonaHoraria.includes('America/Bogota') || zonaHoraria.includes('America/Colombia')) {
                    codigoPais = '57';
                } else if (zonaHoraria.includes('America/Mexico')) {
                    codigoPais = '52';
                } else if (zonaHoraria.includes('America/Argentina')) {
                    codigoPais = '54';
                } else if (zonaHoraria.includes('America/Lima')) {
                    codigoPais = '51';
                } else if (zonaHoraria.includes('America/Santiago')) {
                    codigoPais = '56';
                } else if (zonaHoraria.includes('America/Caracas')) {
                    codigoPais = '58';
                } else if (zonaHoraria.includes('America/Guayaquil')) {
                    codigoPais = '593';
                } else if (zonaHoraria.includes('America/La_Paz')) {
                    codigoPais = '591';
                } else if (zonaHoraria.includes('America/Asuncion')) {
                    codigoPais = '595';
                } else if (zonaHoraria.includes('America/Montevideo')) {
                    codigoPais = '598';
                } else if (zonaHoraria.includes('America/Panama')) {
                    codigoPais = '507';
                } else if (zonaHoraria.includes('America/Costa_Rica')) {
                    codigoPais = '506';
                } else if (zonaHoraria.includes('America/Guatemala')) {
                    codigoPais = '502';
                } else if (zonaHoraria.includes('America/Managua')) {
                    codigoPais = '505';
                } else if (zonaHoraria.includes('America/Tegucigalpa')) {
                    codigoPais = '504';
                } else if (zonaHoraria.includes('America/El_Salvador')) {
                    codigoPais = '503';
                } else if (zonaHoraria.includes('Europe/Madrid')) {
                    codigoPais = '34';
                }

                // Generar opciones de roles
                const opcionesRoles = rolesAUsar.map(rol =>
                    `<option value="${rol.rol}">${rol.nombre_display}${rol.descripcion ? ' - ' + rol.descripcion : ''}</option>`
                ).join('');

                // Cargar formulario con roles
                modalBody.innerHTML = `
            <div id="successUsuario" class="success-message"></div>
            <div id="errorUsuario" class="error"></div>
            
            <form id="formCrearUsuario" onsubmit="submitUsuario(event)">
                <div class="form-group">
                    <label for="nombreUsuario" class="required">Nombre completo</label>
                    <input 
                        type="text" 
                        id="nombreUsuario" 
                        placeholder="Nombre del usuario" 
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="codigoPais" class="required">C√≥digo de pa√≠s</label>
                    <input 
                        type="text" 
                        id="codigoPais" 
                        value="${codigoPais}"
                        readonly
                        style="background-color: #f5f5f5;"
                    >
                    <small style="color: #666; font-size: 12px;">Detectado autom√°ticamente seg√∫n tu zona horaria</small>
                </div>
                
                <div class="form-group">
                    <label for="telefonoUsuario" class="required">N√∫mero de tel√©fono</label>
                    <input 
                        type="tel" 
                        id="telefonoUsuario" 
                        placeholder="3001234567" 
                        required
                        pattern="[0-9]{10,15}"
                    >
                    <small style="color: #666; font-size: 12px;">Solo n√∫meros, sin el c√≥digo de pa√≠s</small>
                </div>
                
                <div class="form-group">
                    <label for="rolUsuario" class="required">Rol del usuario</label>
                    <select id="rolUsuario" required>
                        <option value="">Seleccionar rol...</option>
                        ${opcionesRoles}
                    </select>
                </div>
                
                <button type="submit" id="btnSubmitUsuario">Crear Usuario</button>
            </form>
        `;

            } catch (error) {
                console.error('‚ùå Error cargando formulario:', error);
                modalBody.innerHTML = `
            <div class="error show">
                Error al cargar el formulario: ${error.message}
            </div>
        `;
            }
        }

        // Enviar formulario de usuario
        async function submitUsuario(event) {
            event.preventDefault();

            const btnSubmit = document.getElementById('btnSubmitUsuario');
            const nombreInput = document.getElementById('nombreUsuario');
            const telefonoInput = document.getElementById('telefonoUsuario');
            const codigoPaisInput = document.getElementById('codigoPais');
            const rolSelect = document.getElementById('rolUsuario');

            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Creando...';

            try {
                const nombre = nombreInput.value.trim();
                const telefono = telefonoInput.value.trim();
                const codigoPais = codigoPaisInput.value.trim();
                const rolSeleccionado = rolSelect.value;

                // Validar campos
                if (!nombre) {
                    throw new Error('El nombre es requerido');
                }

                if (!telefono) {
                    throw new Error('El tel√©fono es requerido');
                }

                if (!rolSeleccionado) {
                    throw new Error('Debes seleccionar un rol');
                }

                // Combinar c√≥digo de pa√≠s con tel√©fono
                const telefonoCompleto = codigoPais + telefono;

                console.log('üìù Creando usuario:', { nombre, telefono: telefonoCompleto, rol: rolSeleccionado });

                // Obtener informaci√≥n del rol directamente de roles_templates
                const { data: rolInfo, error: errorRol } = await supabase
                    .from('roles_templates')
                    .select('rol, nombre_display, descripcion, permisos')
                    .eq('rol', rolSeleccionado)
                    .eq('activo', true)
                    .single();

                if (errorRol) {
                    console.error('‚ùå Error obteniendo rol:', errorRol);
                    throw new Error('Error al obtener informaci√≥n del rol: ' + errorRol.message);
                }

                console.log('üìã Respuesta roles_templates:', rolInfo);

                if (!rolInfo) {
                    throw new Error('No se encontr√≥ informaci√≥n del rol');
                }

                // Validar que los permisos existan y sean un objeto v√°lido
                if (!rolInfo.permisos || typeof rolInfo.permisos !== 'object') {
                    throw new Error('El rol no tiene permisos v√°lidos definidos');
                }

                console.log('üìã Info del rol completa:', rolInfo);
                console.log('üîë Permisos del rol (tipo):', typeof rolInfo.permisos);
                console.log('üîë Permisos del rol (contenido):', JSON.stringify(rolInfo.permisos, null, 2));

                // Preparar datos para insertar - IMPORTANTE: permisos debe ser el objeto JSON directo
                const permisosParaInsertar = typeof rolInfo.permisos === 'string'
                    ? JSON.parse(rolInfo.permisos)
                    : rolInfo.permisos;

                console.log('üîê Permisos procesados:', JSON.stringify(permisosParaInsertar, null, 2));

                const datosUsuario = {
                    tenant_id: userData.tenant_id,
                    telefono_whatsapp: telefonoCompleto,
                    phone_number_id: userData.tenants.phone_number_id || userData.phone_number_id,
                    nombre: nombre,
                    rol: rolSeleccionado,
                    activo: true,
                    permisos: permisosParaInsertar
                };

                console.log('üìù Datos a insertar:', datosUsuario);
                console.log('üîë Tipo de permisos:', typeof datosUsuario.permisos);
                console.log('üîë Permisos JSON:', JSON.stringify(datosUsuario.permisos, null, 2));

                // Insertar usuario en tenant_users
                const { data: nuevoUsuario, error: errorUsuario } = await supabase
                    .from('tenant_users')
                    .insert(datosUsuario)
                    .select('*, permisos')  // Asegurarnos de que devuelva los permisos
                    .single();

                if (errorUsuario) {
                    console.error('‚ùå Error insertando usuario:', errorUsuario);
                    console.error('‚ùå Detalle del error:', JSON.stringify(errorUsuario, null, 2));
                    throw new Error('Error al crear usuario: ' + errorUsuario.message);
                }

                console.log('‚úÖ Usuario creado:', nuevoUsuario);
                console.log('‚úÖ Permisos guardados:', nuevoUsuario.permisos);

                // Verificar que los permisos se guardaron correctamente
                if (!nuevoUsuario.permisos) {
                    console.warn('‚ö†Ô∏è ADVERTENCIA: El usuario se cre√≥ pero los permisos est√°n vac√≠os');
                }

                // Mostrar mensaje de √©xito
                const mensajeExito = `‚úÖ ¬°Usuario creado exitosamente!

üë§ Nombre: ${nuevoUsuario.nombre}
üì± Tel√©fono: ${nuevoUsuario.telefono_whatsapp}
üëî Rol: ${rolInfo.nombre_display}
üè™ Negocio: ${userData.tenants.nombre_negocio}

El usuario ya puede acceder al sistema.`;

                mostrarExitoUsuario(mensajeExito);

                // Ocultar formulario
                document.getElementById('formCrearUsuario').style.display = 'none';

                console.log('‚úÖ Usuario registrado exitosamente');

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarErrorUsuario(error.message || 'Error al crear usuario');
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Crear Usuario';
            }
        }

        // Mostrar error en usuario
        function mostrarErrorUsuario(mensaje) {
            const errorDiv = document.getElementById('errorUsuario');
            const successDiv = document.getElementById('successUsuario');

            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.classList.add('show');
            }
            if (successDiv) {
                successDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (errorDiv) errorDiv.classList.remove('show');
            }, 5000);
        }

        // Mostrar √©xito en usuario
        function mostrarExitoUsuario(mensaje) {
            const successDiv = document.getElementById('successUsuario');
            const errorDiv = document.getElementById('errorUsuario');

            if (successDiv) {
                successDiv.textContent = mensaje;
                successDiv.classList.add('show');
            }
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }

            // Agregar bot√≥n para cerrar
            setTimeout(() => {
                const btnCerrar = document.createElement('button');
                btnCerrar.textContent = 'Cerrar';
                btnCerrar.style.marginTop = '20px';
                btnCerrar.onclick = () => closeModalUsuario();
                successDiv.appendChild(btnCerrar);
            }, 100);
        }

        // Mostrar error en compra
        function mostrarErrorCompra(mensaje) {
            const errorDiv = document.getElementById('errorCompra');
            const successDiv = document.getElementById('successCompra');

            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.classList.add('show');
            }
            if (successDiv) {
                successDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (errorDiv) errorDiv.classList.remove('show');
            }, 5000);
        }

        // Mostrar √©xito en compra
        function mostrarExitoCompra(mensaje) {
            const successDiv = document.getElementById('successCompra');
            const errorDiv = document.getElementById('errorCompra');

            if (successDiv) {
                successDiv.textContent = mensaje;
                successDiv.classList.add('show');
            }
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }
        }

        // Cargar formulario de compra
        async function cargarFormularioCompra(modalBody) {
            modalBody.innerHTML = `
        <div id="successCompra" class="success-message"></div>
        <div id="errorCompra" class="error"></div>
        
        <div id="compraForm">
            <!-- Producto con autocompletado -->
            <div class="form-group">
                <label for="productoCompra" class="required">Producto</label>
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="productoCompra" 
                        placeholder="Escribe para buscar..." 
                        autocomplete="off"
                        required
                    >
                    <div class="autocomplete-list" id="autocompleteListCompra"></div>
                </div>
                <div class="info-stock" id="stockInfoCompra"></div>
            </div>
            
            <!-- Medida de Compra -->
            <div class="form-group">
                <label class="required">Medida de Compra</label>
                <div class="medida-options" id="medidaOptionsCompra">
                    <p style="color: #888;">Selecciona un producto primero</p>
                </div>
            </div>
            
            <!-- Cantidad -->
            <div class="form-group">
                <label for="cantidadCompra" class="required">Cantidad</label>
                <input 
                    type="number" 
                    id="cantidadCompra" 
                    placeholder="Ej: 5" 
                    step="0.01" 
                    required
                >
            </div>
            
            <!-- Valor Total -->
            <div class="form-group">
                <label for="valorTotalCompra" class="required">Valor Total Compra</label>
                <input 
                    type="number" 
                    id="valorTotalCompra" 
                    placeholder="Ingresa el valor total" 
                    step="0.01"
                    required
                    style="font-size: 20px; font-weight: 700; color: #667eea;"
                >
            </div>
            
            <button type="button" id="submitBtnCompra">Registrar Compra</button>
        </div>
    `;

            // Inicializar funcionalidad del formulario
            await inicializarFormularioCompra();
        }

        // Generar opciones de medida para compra
        function generarOpcionesMedidaCompra(producto, medidaElement) {
            medidaElement.innerHTML = '';

            const medidas = [
                {
                    value: producto.unidad_venta,
                    label: producto.unidad_venta
                },
                {
                    value: producto.unidad_compra,
                    label: producto.unidad_compra
                }
            ];

            medidas.forEach((medida, index) => {
                const div = document.createElement('div');
                div.className = 'radio-group';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'medidaCompra';
                radio.value = medida.value;
                radio.id = `medidaCompra_${index}`;
                radio.required = true;
                if (index === 0) radio.checked = true;

                const label = document.createElement('label');
                label.htmlFor = `medidaCompra_${index}`;
                label.textContent = medida.label;

                div.appendChild(radio);
                div.appendChild(label);
                medidaElement.appendChild(div);
            });
        }

        // Calcular unidades ingresadas seg√∫n tipo de venta
        function calcularUnidadesIngresadasCompra(producto, cantidad, unidadMedida) {
            const stockActual = parseFloat(producto.stock_actual) || 0;
            const tipoVenta = producto.tipo_venta;
            const unidadVenta = producto.unidad_venta;
            const factor = parseFloat(producto.factor_unidades) || 1;

            let unidadesIngresadas;

            if (tipoVenta === 'peso') {
                const unidadMedidaNorm = unidadMedida.toLowerCase().replace(/s$/, '');
                const unidadVentaNorm = unidadVenta.toLowerCase().replace(/s$/, '');

                if (unidadMedidaNorm === unidadVentaNorm) {
                    unidadesIngresadas = cantidad;
                } else {
                    unidadesIngresadas = cantidad * factor;
                }
            } else if (tipoVenta === 'medida') {
                const unidadMedidaNorm = unidadMedida.toLowerCase().replace(/s$/, '');
                const unidadVentaNorm = unidadVenta.toLowerCase().replace(/s$/, '');

                if (unidadMedidaNorm === unidadVentaNorm) {
                    unidadesIngresadas = cantidad;
                } else {
                    unidadesIngresadas = cantidad * factor;
                }
            } else {
                if (unidadMedida === 'unidades' || unidadMedida === 'unidad') {
                    unidadesIngresadas = cantidad;
                } else {
                    unidadesIngresadas = cantidad * factor;
                }
            }

            const nuevoStock = stockActual + unidadesIngresadas;

            return {
                unidadesIngresadas,
                nuevoStock,
                stockAnterior: stockActual
            };
        }

        // Enviar compra desde el panel
        async function enviarCompraPanel() {
            const productoSeleccionado = window.productoSeleccionadoCompra();
            const cantidadInput = document.getElementById('cantidadCompra');
            const valorTotalInput = document.getElementById('valorTotalCompra');
            const submitBtn = document.getElementById('submitBtnCompra');

            // Validar
            if (!productoSeleccionado) {
                mostrarErrorCompra('Debes seleccionar un producto');
                return;
            }

            if (!cantidadInput.value || parseFloat(cantidadInput.value) <= 0) {
                mostrarErrorCompra('La cantidad debe ser mayor a 0');
                return;
            }

            if (!valorTotalInput.value || parseFloat(valorTotalInput.value) <= 0) {
                mostrarErrorCompra('El valor total debe ser mayor a 0');
                return;
            }

            if (!document.querySelector('input[name="medidaCompra"]:checked')) {
                mostrarErrorCompra('Debes seleccionar una medida de compra');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Registrando...';

            try {
                const medidaSeleccionada = document.querySelector('input[name="medidaCompra"]:checked').value;
                const cantidad = parseFloat(cantidadInput.value);
                const valorTotal = parseFloat(valorTotalInput.value);

                console.log('üõí Iniciando registro de compra...');

                // Obtener zona horaria
                const { data: tenantData } = await supabase
                    .from('tenants')
                    .select('zona_horaria')
                    .eq('tenant_id', userData.tenant_id)
                    .single();

                const zonaHoraria = tenantData?.zona_horaria || 'America/Bogota';

                const fechaSQL = new Date().toLocaleDateString('en-CA', {
                    timeZone: zonaHoraria
                });

                // Calcular unidades y nuevo stock
                const calculoStock = calcularUnidadesIngresadasCompra(
                    productoSeleccionado,
                    cantidad,
                    medidaSeleccionada
                );

                const { unidadesIngresadas, nuevoStock, stockAnterior } = calculoStock;
                const nuevoCosto = unidadesIngresadas > 0 ? (valorTotal / unidadesIngresadas) : 0;

                console.log('üìä C√°lculos:', {
                    unidadesIngresadas,
                    stockAnterior,
                    nuevoStock,
                    nuevoCosto
                });

                // Insertar movimiento de inventario
                const { data: movimiento, error: errorMovimiento } = await supabase
                    .from('movimientos_inventario')
                    .insert({
                        tenant_id: userData.tenant_id,
                        producto_id: productoSeleccionado.producto_id,
                        codigo: productoSeleccionado.codigo,
                        cantidad: unidadesIngresadas,
                        tipo: 'entrada',
                        costo_unitario: nuevoCosto,
                        costo_total: valorTotal,
                        razon: `Entrada de ${cantidad} ${medidaSeleccionada}`,
                        user_id: userData.user_id,
                        activo: true,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (errorMovimiento) throw errorMovimiento;
                console.log('‚úÖ Movimiento registrado');

                // Actualizar stock y costo en productos
                const { error: errorProducto } = await supabase
                    .from('productos')
                    .update({
                        stock_actual: nuevoStock,
                        costo: nuevoCosto,
                        updated_at: new Date().toISOString(),
                        updated_by: userData.user_id
                    })
                    .eq('producto_id', productoSeleccionado.producto_id);

                if (errorProducto) throw errorProducto;
                console.log('‚úÖ Stock actualizado');

                // Actualizar o crear caja diaria
                const { data: cajaHoyData } = await supabase
                    .from('caja_diaria')
                    .select('*')
                    .eq('tenant_id', userData.tenant_id)
                    .eq('fecha', fechaSQL);

                let cajaEsperada = 0;

                if (cajaHoyData && cajaHoyData.length > 0) {
                    // Actualizar caja existente
                    const cajaActual = cajaHoyData[0];
                    const comprasActuales = parseFloat(cajaActual.compras_totales) || 0;
                    const nuevasCompras = comprasActuales + valorTotal;

                    const baseInicial = parseFloat(cajaActual.base_inicial) || 0;
                    const ventasTotales = parseFloat(cajaActual.ventas_totales) || 0;
                    const gastosTotales = parseFloat(cajaActual.gastos_totales) || 0;

                    cajaEsperada = baseInicial + ventasTotales - gastosTotales - nuevasCompras;

                    await supabase
                        .from('caja_diaria')
                        .update({
                            compras_totales: nuevasCompras,
                            caja_esperada: cajaEsperada,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', cajaActual.id);

                    console.log('‚úÖ Caja diaria actualizada');
                } else {
                    // Crear nuevo registro de caja
                    const { data: cajaAnteriorData } = await supabase
                        .from('caja_diaria')
                        .select('caja_esperada')
                        .eq('tenant_id', userData.tenant_id)
                        .lt('fecha', fechaSQL)
                        .order('fecha', { ascending: false })
                        .limit(1);

                    const cajaAnterior = cajaAnteriorData && cajaAnteriorData.length > 0
                        ? parseFloat(cajaAnteriorData[0].caja_esperada)
                        : 0;

                    cajaEsperada = cajaAnterior - valorTotal;

                    await supabase
                        .from('caja_diaria')
                        .insert({
                            tenant_id: userData.tenant_id,
                            fecha: fechaSQL,
                            caja_dia_anterior: cajaAnterior,
                            base_agregada: 0,
                            base_inicial: cajaAnterior,
                            ventas_totales: 0,
                            gastos_totales: 0,
                            compras_totales: valorTotal,
                            consumos_totales: 0,
                            mermas_totales: 0,
                            caja_esperada: cajaEsperada,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });

                    console.log('‚úÖ Caja diaria creada');
                }

                // Determinar unidad de stock seg√∫n tipo de venta
                let unidadStock, stockFormateado;

                if (productoSeleccionado.tipo_venta === 'unidad') {
                    unidadStock = 'und';
                    stockFormateado = Math.round(nuevoStock);
                } else if (productoSeleccionado.tipo_venta === 'peso') {
                    unidadStock = productoSeleccionado.unidad_venta || 'libras';
                    stockFormateado = nuevoStock.toFixed(2);
                } else if (productoSeleccionado.tipo_venta === 'medida') {
                    unidadStock = productoSeleccionado.unidad_venta || 'metros';
                    stockFormateado = nuevoStock.toFixed(2);
                } else {
                    unidadStock = 'und';
                    stockFormateado = Math.round(nuevoStock);
                }

                const fechaActual = new Date().toLocaleString('es-CO', {
                    timeZone: zonaHoraria,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });

                const valorFormateado = `$${valorTotal.toLocaleString('es-CO', { maximumFractionDigits: 0 })}`;
                const cajaFormateada = `$${cajaEsperada.toLocaleString('es-CO', { maximumFractionDigits: 0 })}`;

                const mensajeExito = `‚úÖ Registro de entrada a Inventario
${fechaActual}

[${productoSeleccionado.codigo}] ${cantidad} ${medidaSeleccionada} ${productoSeleccionado.producto} - ${valorFormateado} / Stock: ${stockFormateado} ${unidadStock}

üí∞ Total de la COMPRA: ${valorFormateado}
üíº Caja esperada: ${cajaFormateada}`;

                mostrarExitoCompra(mensajeExito);

                // Ocultar formulario
                document.getElementById('compraForm').classList.add('hidden');
                submitBtn.classList.add('hidden');

                console.log('‚úÖ Compra registrada exitosamente');

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarErrorCompra('Error al registrar la compra: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar Compra';
            }
        }

        // Inicializar formulario de compra
        async function inicializarFormularioCompra() {
            let productosData = [];
            let productoSeleccionado = null;

            // Cargar productos
            try {
                const { data, error } = await supabase
                    .from('productos')
                    .select('*')
                    .eq('tenant_id', userData.tenant_id)
                    .eq('activo', true);

                if (error) throw error;
                productosData = data;

                console.log('üì¶ Productos cargados para compra:', productosData.length);
            } catch (error) {
                console.error('Error cargando productos:', error);
                mostrarErrorCompra('Error cargando productos: ' + error.message);
                return;
            }

            // Elementos del DOM
            const productoInput = document.getElementById('productoCompra');
            const autocompleteList = document.getElementById('autocompleteListCompra');
            const stockInfo = document.getElementById('stockInfoCompra');
            const medidaOptionsDiv = document.getElementById('medidaOptionsCompra');

            const submitBtn = document.getElementById('submitBtnCompra');

            // Agregar event listener al bot√≥n
            submitBtn.addEventListener('click', enviarCompraPanel);

            // Autocompletado
            productoInput.addEventListener('input', (e) => {
                const valor = e.target.value.toLowerCase().trim();

                if (valor.length === 0) {
                    autocompleteList.classList.remove('active');
                    productoSeleccionado = null;
                    stockInfo.textContent = '';
                    medidaOptionsDiv.innerHTML = '<p style="color: #888;">Selecciona un producto primero</p>';
                    return;
                }

                const filtrados = productosData.filter(p =>
                    p.producto.toLowerCase().includes(valor) ||
                    p.codigo.toLowerCase().includes(valor) ||
                    (p.apodos_input && p.apodos_input.toLowerCase().includes(valor))
                );

                mostrarAutocompleteCompra(filtrados, autocompleteList, stockInfo, medidaOptionsDiv);
            });

            // Funci√≥n para mostrar autocomplete
            function mostrarAutocompleteCompra(productos, listElement, stockElement, medidaElement) {
                listElement.innerHTML = '';

                if (productos.length === 0) {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = '<div class="autocomplete-item-nombre" style="color: #999;">No se encontraron productos</div>';
                    listElement.appendChild(div);
                    listElement.classList.add('active');
                    return;
                }

                productos.forEach(prod => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `
                <div class="autocomplete-item-nombre">${prod.producto}</div>
                <div class="autocomplete-item-codigo">C√≥digo: ${prod.codigo} | Stock: ${prod.stock_actual} ${prod.unidad_venta}</div>
            `;
                    div.addEventListener('click', () => {
                        productoSeleccionado = prod;
                        productoInput.value = `${prod.producto} (${prod.codigo})`;
                        listElement.classList.remove('active');
                        stockElement.textContent = `Stock actual: ${prod.stock_actual} ${prod.unidad_venta}`;
                        generarOpcionesMedidaCompra(prod, medidaElement);
                    });
                    listElement.appendChild(div);
                });

                listElement.classList.add('active');
            }

            // Cerrar autocomplete al hacer click afuera
            document.addEventListener('click', (e) => {
                if (e.target !== productoInput && !autocompleteList.contains(e.target)) {
                    autocompleteList.classList.remove('active');
                }
            });

            // Cerrar sugerencias de mesas al hacer click fuera
            document.addEventListener('click', (e) => {
                document.querySelectorAll('[id^="sugerencias-"]').forEach(sugerencias => {
                    const mesaId = sugerencias.id.replace('sugerencias-', '');
                    const inputBuscar = document.getElementById(`buscar-${mesaId}`);
                    if (inputBuscar && e.target !== inputBuscar && !sugerencias.contains(e.target)) {
                        sugerencias.style.display = 'none';
                    }
                });
            });

            // Guardar referencia al producto seleccionado para usarlo en enviarCompraPanel
            window.productoSeleccionadoCompra = () => productoSeleccionado;
        }

        // Actualizar campos seg√∫n tipo de venta
        function updateFormByType() {
            const tipo = document.getElementById('tipoVenta').value;
            const container = document.getElementById('camposDinamicos');

            let html = '';

            if (tipo === 'unidad') {
                html = `
            <div class="form-group">
    <label>Unidad de compra *</label>
    <select id="unidadCompra" required onchange="toggleUnidadCompraPersonalizada()">
        <option value="">Seleccionar...</option>
        <option value="CAJA">CAJA</option>
        <option value="PACA">PACA</option>
        <option value="UNIDAD">UNIDAD</option>
        <option value="PAQUETE">PAQUETE</option>
        <option value="BOLSA">BOLSA</option>
        <option value="OTRA">OTRA (Especificar)</option>
    </select>
</div>
<div class="form-group" id="campoUnidadPersonalizada" style="display: none;">
    <label>Especificar unidad de compra *</label>
    <input type="text" id="unidadCompraPersonalizada" placeholder="Ej: BOTELLA, GARRAFA, etc.">
</div>
            <div class="form-group">
                <label id="labelFactorUnidad">Factor *</label>
                <input type="number" id="factor" required min="1" step="1" value="1">
            </div>
            <div class="form-group">
                <label>Stock inicial (unidades) *</label>
                <input type="number" id="stock" required min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Precio unitario *</label>
                <input type="number" id="precio" required min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Costo unitario *</label>
                <input type="number" id="costo" required min="0" step="0.01">
            </div>
        `;

                container.innerHTML = html;

                // ‚≠ê LISTENERS PARA UNIDAD - SE AGREGAN AQU√ç
                setTimeout(() => {
                    const unidadCompraSelect = document.getElementById('unidadCompra');
                    const labelFactor = document.getElementById('labelFactorUnidad');

                    function actualizarLabelFactorUnidad() {
                        let unidadCompra;
                        if (unidadCompraSelect.value === 'OTRA') {
                            const unidadPersonalizada = document.getElementById('unidadCompraPersonalizada').value.trim().toUpperCase();
                            unidadCompra = unidadPersonalizada || 'unidad de compra';
                        } else {
                            unidadCompra = unidadCompraSelect.value || 'unidad de compra';
                        }
                        labelFactor.textContent = `¬øCu√°ntas unidades tiene 1 ${unidadCompra}? *`;
                    }

                    unidadCompraSelect.addEventListener('change', actualizarLabelFactorUnidad);
                    const unidadPersonalizadaInput = document.getElementById('unidadCompraPersonalizada');
                    unidadPersonalizadaInput.addEventListener('input', actualizarLabelFactorUnidad);
                }, 0);

            } else if (tipo === 'peso') {
                html = `
            <div class="form-group">
                <label>Unidad de venta *</label>
                <select id="unidadVenta" required>
                    <option value="">Seleccionar...</option>
                    <option value="libras">Libras</option>
                    <option value="kilogramos">Kilogramos</option>
                    <option value="gramos">Gramos</option>
                </select>
            </div>
            <div class="form-group">
    <label>Unidad de compra *</label>
    <select id="unidadCompra" required onchange="toggleUnidadCompraPersonalizada()">
        <option value="">Seleccionar...</option>
        <option value="BULTO">BULTO</option>
        <option value="LIBRA">LIBRA</option>
        <option value="KILO">KILO</option>
        <option value="ARROBA">ARROBA</option>
        <option value="OTRA">OTRA (Especificar)</option>
    </select>
</div>
<div class="form-group" id="campoUnidadPersonalizada" style="display: none;">
    <label>Especificar unidad de compra *</label>
    <input type="text" id="unidadCompraPersonalizada" placeholder="Ej: BOTELLA, GARRAFA, etc." style="text-transform: uppercase;">
</div>
            <div class="form-group">
                <label id="labelFactorPeso">Factor *</label>
                <input type="number" id="factor" required min="0.01" step="0.01">
            </div>
            <div class="form-group">
    <label id="labelStockPeso">Stock inicial *</label>
    <input type="number" id="stock" required min="0" step="0.01">
</div>
            <div class="form-group">
                <label id="labelPrecioPeso">Precio por unidad de venta *</label>
                <input type="number" id="precio" required min="0" step="0.01">
            </div>
            <div class="form-group">
                <label id="labelCostoPeso">Costo por unidad de venta *</label>
                <input type="number" id="costo" required min="0" step="0.01">
            </div>
        `;

                container.innerHTML = html;


                // ‚≠ê LISTENERS PARA PESO - SE AGREGAN AQU√ç
                setTimeout(() => {
                    const labelStockPeso = document.getElementById('labelStockPeso');
                    const unidadVentaSelect = document.getElementById('unidadVenta');
                    const unidadCompraSelect = document.getElementById('unidadCompra');
                    const labelFactor = document.getElementById('labelFactorPeso');
                    const labelPrecio = document.getElementById('labelPrecioPeso');
                    const labelCosto = document.getElementById('labelCostoPeso');

                    function actualizarLabelStockPeso() {
                        const unidadVenta = unidadVentaSelect.value || 'unidad de venta';
                        labelStockPeso.textContent = `Stock inicial (en ${unidadVenta}) *`;
                    }

                    function actualizarLabelFactorPeso() {
                        const unidadVenta = unidadVentaSelect.value || 'unidad de venta';
                        let unidadCompra;
                        if (unidadCompraSelect.value === 'OTRA') {
                            const unidadPersonalizada = document.getElementById('unidadCompraPersonalizada').value.trim().toUpperCase();
                            unidadCompra = unidadPersonalizada || 'unidad de compra';
                        } else {
                            unidadCompra = unidadCompraSelect.value || 'unidad de compra';
                        }
                        labelFactor.textContent = `¬øCu√°ntas ${unidadVenta} tiene 1 ${unidadCompra}? *`;
                    }

                    function actualizarLabelsPrecioCostoPeso() {
                        const unidadVenta = unidadVentaSelect.value || 'unidad de venta';
                        labelPrecio.textContent = `Precio por ${unidadVenta} *`;
                        labelCosto.textContent = `Costo por ${unidadVenta} *`;
                    }

                    unidadVentaSelect.addEventListener('change', () => {
                        actualizarLabelFactorPeso();
                        actualizarLabelsPrecioCostoPeso();
                        actualizarLabelStockPeso();
                    });
                    unidadCompraSelect.addEventListener('change', actualizarLabelFactorPeso);
                    const unidadPersonalizadaInput = document.getElementById('unidadCompraPersonalizada');
                    unidadPersonalizadaInput.addEventListener('input', actualizarLabelFactorPeso);
                }, 0);

            } else if (tipo === 'medida') {
                html = `
            <div class="form-group">
                <label>Unidad de venta *</label>
                <select id="unidadVenta" required>
                    <option value="">Seleccionar...</option>
                    <option value="metros">Metros</option>
                    <option value="centimetros">Cent√≠metros</option>
                    <option value="milimetros">Mil√≠metros</option>
                </select>
            </div>
            <div class="form-group">
    <label>Unidad de compra *</label>
    <select id="unidadCompra" required onchange="toggleUnidadCompraPersonalizada()">
        <option value="">Seleccionar...</option>
        <option value="ROLLO">ROLLO</option>
        <option value="LAMINA">LAMINA</option>
        <option value="BOBINA">BOBINA</option>
        <option value="METRO">METRO</option>
        <option value="OTRA">OTRA (Especificar)</option>
    </select>
</div>
<div class="form-group" id="campoUnidadPersonalizada" style="display: none;">
    <label>Especificar unidad de compra *</label>
    <input type="text" id="unidadCompraPersonalizada" placeholder="Ej: PLIEGO, HOJA, etc." style="text-transform: uppercase;">
</div>
            <div class="form-group">
                <label id="labelFactorMedida">Factor *</label>
                <input type="number" id="factor" required min="0.01" step="0.01">
            </div>
            <div class="form-group">
    <label id="labelStockMedida">Stock inicial *</label>
    <input type="number" id="stock" required min="0" step="0.01">
</div>
            <div class="form-group">
                <label id="labelPrecioMedida">Precio por unidad de venta *</label>
                <input type="number" id="precio" required min="0" step="0.01">
            </div>
            <div class="form-group">
                <label id="labelCostoMedida">Costo por unidad de venta *</label>
                <input type="number" id="costo" required min="0" step="0.01">
            </div>
        `;

                container.innerHTML = html;


                // ‚≠ê LISTENERS PARA MEDIDA - SE AGREGAN AQU√ç
                setTimeout(() => {
                    const labelStockMedida = document.getElementById('labelStockMedida');
                    const unidadVentaSelect = document.getElementById('unidadVenta');
                    const unidadCompraSelect = document.getElementById('unidadCompra');
                    const labelFactor = document.getElementById('labelFactorMedida');
                    const labelPrecio = document.getElementById('labelPrecioMedida');
                    const labelCosto = document.getElementById('labelCostoMedida');

                    function actualizarLabelStockMedida() {
                        const unidadVenta = unidadVentaSelect.value || 'unidad de venta';
                        labelStockMedida.textContent = `Stock inicial (en ${unidadVenta}) *`;
                    }

                    function actualizarLabelFactorMedida() {
                        const unidadVenta = unidadVentaSelect.value || 'unidad de venta';
                        let unidadCompra;
                        if (unidadCompraSelect.value === 'OTRA') {
                            const unidadPersonalizada = document.getElementById('unidadCompraPersonalizada').value.trim().toUpperCase();
                            unidadCompra = unidadPersonalizada || 'unidad de compra';
                        } else {
                            unidadCompra = unidadCompraSelect.value || 'unidad de compra';
                        }
                        labelFactor.textContent = `¬øCu√°ntos ${unidadVenta} tiene 1 ${unidadCompra}? *`;
                    }

                    function actualizarLabelsPrecioCostoMedida() {
                        const unidadVenta = unidadVentaSelect.value || 'unidad de venta';
                        labelPrecio.textContent = `Precio por ${unidadVenta} *`;
                        labelCosto.textContent = `Costo por ${unidadVenta} *`;
                    }

                    unidadVentaSelect.addEventListener('change', () => {
                        actualizarLabelFactorMedida();
                        actualizarLabelsPrecioCostoMedida();
                        actualizarLabelStockMedida();
                    });
                    unidadCompraSelect.addEventListener('change', actualizarLabelFactorMedida);
                    const unidadPersonalizadaInput = document.getElementById('unidadCompraPersonalizada');
                    unidadPersonalizadaInput.addEventListener('input', actualizarLabelFactorMedida);
                }, 0);
            }
        }

        // Funci√≥n para agregar apodo en crear producto
        function agregarApodoCrear() {
            const input = document.getElementById('nuevoApodoCrear');
            const apodo = input.value.trim().toLowerCase();

            if (!apodo) {
                alert('Debes escribir un apodo');
                return;
            }

            // Validar que no exista ya
            if (window.apodosCrearProducto.includes(apodo)) {
                alert('Este apodo ya est√° agregado');
                input.value = '';
                return;
            }

            // Agregar al array
            window.apodosCrearProducto.push(apodo);

            // Limpiar input
            input.value = '';

            // Renderizar lista
            renderizarApodosCrear();
        }

        // Funci√≥n para eliminar apodo en crear producto
        function eliminarApodoCrear(apodo) {
            // Obtener el nombre del producto actual
            const nombreProducto = document.getElementById('productoNombre').value.trim().toLowerCase();

            // Verificar si el apodo a eliminar es el nombre del producto
            if (apodo === nombreProducto) {
                alert('No puedes eliminar el nombre del producto de los apodos');
                return;
            }

            const index = window.apodosCrearProducto.indexOf(apodo);
            if (index > -1) {
                window.apodosCrearProducto.splice(index, 1);
                renderizarApodosCrear();
            }
        }

        // Funci√≥n para renderizar la lista de apodos
        function renderizarApodosCrear() {
            const container = document.getElementById('apodosItemsCrear');

            if (window.apodosCrearProducto.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 13px; margin: 0;">No hay apodos agregados a√∫n</p>';
            } else {
                container.innerHTML = window.apodosCrearProducto.map(apodo => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #f5f7ff; border-radius: 6px; margin-bottom: 6px;">
                <span style="font-weight: 500; color: #333; font-size: 13px;">üè∑Ô∏è ${apodo}</span>
                <button 
                    type="button"
                    onclick="eliminarApodoCrear('${apodo}')"
                    style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; min-width: auto; width: auto;"
                >
                    üóëÔ∏è
                </button>
            </div>
        `).join('');
            }

            // Actualizar input oculto
            document.getElementById('apodos').value = window.apodosCrearProducto.join(',');
        }

        // Enviar formulario
        async function submitProducto(event) {
            event.preventDefault();
            console.log('üì§ Enviando formulario...');

            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Creando...';

            try {
                // Asegurar que el nombre del producto est√© en los apodos
                const nombreProducto = document.getElementById('productoNombre').value.trim().toLowerCase();
                if (nombreProducto && !window.apodosCrearProducto.includes(nombreProducto)) {
                    window.apodosCrearProducto.push(nombreProducto);
                }

                // ‚úÖ NUEVO: Obtener tipo de producto
                const tipoProducto = document.querySelector('input[name="tipoProducto"]:checked').value;
                const esProcesado = tipoProducto === 'procesado';

                // ‚úÖ NUEVO: Validar receta si es procesado
                if (esProcesado && ingredientesReceta.length === 0) {
                    throw new Error('Los productos procesados deben tener al menos 1 ingrediente en la receta');
                }

                // Recolectar datos
                // Capturar unidad de compra (normal o personalizada)
                let unidadCompra = document.getElementById('unidadCompra').value;
                if (unidadCompra === 'OTRA') {
                    const unidadPersonalizada = document.getElementById('unidadCompraPersonalizada').value.trim().toUpperCase();
                    if (!unidadPersonalizada) {
                        throw new Error('Debes especificar la unidad de compra personalizada');
                    }
                    unidadCompra = unidadPersonalizada;
                }

                const formData = {
                    producto: document.getElementById('productoNombre').value,
                    tipo_venta: document.getElementById('tipoVenta').value,
                    unidad_compra: unidadCompra,
                    factor: parseFloat(document.getElementById('factor').value),
                    stock: parseFloat(document.getElementById('stock').value),
                    precio: parseFloat(document.getElementById('precio').value),
                    costo: parseFloat(document.getElementById('costo').value),
                    apodos: window.apodosCrearProducto.join(','),
                    unidad_venta: document.getElementById('unidadVenta')?.value || 'unidades',
                    tenant_id: userData.tenant_id,
                    tenant_user_id: userData.tenant_user_id || null,
                    es_procesado: esProcesado,  // ‚úÖ NUEVO
                    tiene_receta: esProcesado   // ‚úÖ NUEVO
                };

                console.log('üì¶ Datos a enviar:', formData);
                console.log('üîë Tenant User ID:', formData.tenant_user_id);
                console.log('üè¢ Tenant ID:', formData.tenant_id);
                console.log('üç¥ Es procesado:', formData.es_procesado);

                // Insertar producto usando RPC (funci√≥n segura)
                const { data: producto, error: errorProducto } = await supabase
                    .rpc('crear_producto_panel', {
                        p_tenant_id: formData.tenant_id,
                        p_producto: formData.producto,
                        p_precio_venta: formData.precio,
                        p_costo: formData.costo,
                        p_factor_unidades: formData.factor,
                        p_apodos_input: formData.apodos || '',
                        p_tipo_venta: formData.tipo_venta,
                        p_unidad_venta: formData.unidad_venta,
                        p_unidad_compra: formData.unidad_compra,
                        p_stock_actual: formData.stock,
                        p_stock_inicial: formData.stock,
                        p_updated_by: formData.tenant_user_id
                    });

                if (errorProducto) {
                    console.error('‚ùå Error insertando producto:', errorProducto);
                    throw new Error(errorProducto.message || 'Error al crear producto');
                }

                if (!producto || producto.length === 0) {
                    throw new Error('No se recibi√≥ respuesta del servidor');
                }

                const productoCreado = Array.isArray(producto) ? producto[0] : producto;
                console.log('‚úÖ Producto insertado:', productoCreado);

                // Verificar que tengamos todos los campos necesarios
                if (!productoCreado.codigo) {
                    throw new Error('El producto se cre√≥ pero no se recibi√≥ el c√≥digo');
                }

                // ‚úÖ NUEVO: Actualizar campos es_procesado y tiene_receta
                if (esProcesado) {
                    const { error: errorUpdate } = await supabase
                        .from('productos')
                        .update({
                            es_procesado: true,
                            tiene_receta: true,
                            updated_at: new Date().toISOString(),
                            updated_by: formData.tenant_user_id
                        })
                        .eq('producto_id', productoCreado.producto_id);

                    if (errorUpdate) {
                        console.error('‚ö†Ô∏è Error actualizando flags:', errorUpdate);
                        // No lanzamos error, solo advertencia
                    }
                }

                console.log('üéØ CHECKPOINT 1: Antes de procesar apodos');
                console.log('üéØ productoCreado completo:', productoCreado);

                // Procesar e insertar apodos
                let apodosInsertados = [];
                if (formData.apodos && formData.apodos.trim() !== '') {
                    const apodosArray = formData.apodos
                        .split(',')
                        .map(a => a.trim())
                        .filter(a => a !== '')
                        .map(apodo => ({
                            tenant_id: formData.tenant_id,
                            producto_id: productoCreado.producto_id,
                            apodo: apodo.toLowerCase(),
                            producto: productoCreado.producto
                        }));

                    if (apodosArray.length > 0) {
                        const { data: apodos, error: errorApodos } = await supabase
                            .from('productos_apodos')
                            .insert(apodosArray)
                            .select();

                        if (errorApodos) throw errorApodos;
                        apodosInsertados = apodos;
                        console.log('‚úÖ Apodos insertados:', apodosInsertados);
                    }
                }

                // ‚úÖ NUEVO: Insertar receta si es procesado
                let recetaInsertada = [];
                if (esProcesado && ingredientesReceta.length > 0) {
                    console.log('üç¥ Insertando receta con', ingredientesReceta.length, 'ingredientes');

                    const recetaArray = ingredientesReceta.map((ing, index) => ({
                        tenant_id: formData.tenant_id,
                        producto_procesado_id: productoCreado.producto_id,
                        ingrediente_id: ing.ingrediente_id,
                        cantidad_requerida: ing.cantidad,
                        unidad_medida: ing.unidad,
                        orden_ingrediente: index + 1,
                        created_by: formData.tenant_user_id
                    }));

                    const { data: receta, error: errorReceta } = await supabase
                        .from('productos_recetas')
                        .insert(recetaArray)
                        .select();

                    if (errorReceta) {
                        console.error('‚ùå Error insertando receta:', errorReceta);
                        throw new Error('Error al guardar la receta: ' + errorReceta.message);
                    }

                    recetaInsertada = receta;
                    console.log('‚úÖ Receta insertada:', recetaInsertada);
                }

                console.log('üéØ CHECKPOINT 2: Antes de generar mensaje');
                console.log('üéØ apodosInsertados:', apodosInsertados);

                // Generar mensaje de confirmaci√≥n
                const mensaje = generarMensajeConfirmacion(productoCreado, apodosInsertados, formData, recetaInsertada);

                console.log('üìù Mensaje generado:', mensaje);
                console.log('üìù Longitud del mensaje:', mensaje.length);

                console.log('üéØ CHECKPOINT 3: Mensaje generado, ahora mostrar');

                // Mostrar mensaje de √©xito
                const successDiv = document.getElementById('successMsg');
                const formDiv = document.getElementById('formCrearProducto');

                console.log('üéØ successDiv encontrado:', successDiv);
                console.log('üéØ formDiv encontrado:', formDiv);
                console.log('üéØ successDiv display actual:', successDiv ? successDiv.style.display : 'NO ENCONTRADO');
                console.log('üéØ formDiv display actual:', formDiv ? formDiv.style.display : 'NO ENCONTRADO');

                console.log('üîÑ Intentando actualizar el DOM...');

                successDiv.innerHTML = mensaje;
                console.log('‚úÖ innerHTML actualizado');

                successDiv.classList.add('show');
                console.log('‚úÖ successDiv display = block');

                formDiv.style.display = 'none';
                console.log('‚úÖ formDiv display = none');

                console.log('üéØ successDiv display despu√©s:', successDiv.style.display);
                console.log('üéØ formDiv display despu√©s:', formDiv.style.display);
                console.log('üéØ successDiv innerHTML:', successDiv.innerHTML.substring(0, 100));

                console.log('‚úÖ Producto creado exitosamente');

                // Agregar bot√≥n para cerrar y crear otro
                setTimeout(() => {
                    const btnCerrar = document.createElement('button');
                    btnCerrar.textContent = 'Cerrar';
                    btnCerrar.style.marginTop = '20px';
                    btnCerrar.onclick = () => closeModal();
                    successDiv.appendChild(btnCerrar);
                }, 100);

            } catch (error) {
                console.error('‚ùå Error:', error);
                showError(error.message || 'Error al crear producto');
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Crear Producto';
            }
        }

        // Generar mensaje de confirmaci√≥n
        function generarMensajeConfirmacion(producto, apodos, formData, receta = []) {
            const abreviaturaUnidad = formData.unidad_venta === 'libras' ? 'lbs' :
                formData.unidad_venta === 'kilogramos' ? 'kg' :
                    formData.unidad_venta === 'gramos' ? 'g' :
                        formData.unidad_venta;

            let listaApodos = '';
            if (apodos.length > 0) {
                listaApodos = apodos.map(a => `  ‚Ä¢ ${a.apodo} (${a.apodo_id})`).join('\n');
            } else {
                listaApodos = '  _Sin apodos_';
            }

            let lineaUnidad, lineaStock, lineaPrecio;

            if (formData.tipo_venta === 'peso') {
                lineaUnidad = `üìè Unidad de compra: ${formData.unidad_compra} (x${formData.factor} ${abreviaturaUnidad})\nüìè Unidad de venta: ${formData.unidad_venta}`;
                lineaStock = `üìä Stock inicial: ${producto.stock_actual} ${formData.unidad_venta}`;
                lineaPrecio = `üí∞ Precio por ${formData.unidad_venta}: $${parseFloat(producto.precio_venta).toLocaleString('es-CO')}`;
            } else if (formData.tipo_venta === 'medida') {
                lineaUnidad = `üìè Unidad de compra: ${formData.unidad_compra} (x${formData.factor} ${abreviaturaUnidad})\nüìè Unidad de venta: ${formData.unidad_venta}`;
                lineaStock = `üìä Stock inicial: ${producto.stock_actual} ${formData.unidad_venta}`;
                lineaPrecio = `üí∞ Precio por ${formData.unidad_venta}: $${parseFloat(producto.precio_venta).toLocaleString('es-CO')}`;
            } else {
                lineaUnidad = `üìè Unidad de compra: ${formData.unidad_compra} (x${formData.factor} unidades)`;
                lineaStock = `üìä Stock inicial: ${producto.stock_actual} unidades`;
                lineaPrecio = `üí∞ Precio unitario: $${parseFloat(producto.precio_venta).toLocaleString('es-CO')}`;
            }

            // ‚úÖ NUEVO: Agregar informaci√≥n de receta si es procesado
            let seccionReceta = '';
            if (formData.es_procesado && receta.length > 0) {
                seccionReceta = '\n\nüç¥ Receta (ingredientes por unidad):';
                ingredientesReceta.forEach(ing => {
                    seccionReceta += `\n  ‚Ä¢ [${ing.codigo}] ${ing.nombre}: ${ing.cantidad} ${ing.unidad}`;
                });
            }

            return `‚úÖ ¬°Producto creado exitosamente!${formData.es_procesado ? ' üç¥' : ''}
üì¶ Producto: ${producto.producto}${formData.es_procesado ? ' (Procesado)' : ''}
üî¢ C√≥digo: ${producto.codigo}
${lineaUnidad}
${lineaPrecio}
üíµ Costo: $${parseFloat(producto.costo || 0).toLocaleString('es-CO')}
${lineaStock}
üè∑Ô∏è Apodos registrados:
${listaApodos}${seccionReceta}
üë§ Creado por: ${userData.nombre}
üè™ Negocio: ${userData.tenants.nombre_negocio}

_El producto ya est√° disponible para ventas._`;
        }


        // =====================================================
        // FUNCIONES PARA INFORMES
        // =====================================================

        let datosInformes = null;
        let rangoFechaInformes = 'today';

        // =====================================================
        // NUEVA FUNCI√ìN PARA INFORMES CON DATOS REALES
        // =====================================================

        async function cargarInformes(modalBody) {
            // Mostrar loading inicial
            modalBody.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <p style="font-size: 18px; color: #667eea;">üìä Cargando datos del informe...</p>
        </div>
    `;

            try {
                // Obtener fechas por defecto (hoy)
                const hoy = new Date();
                const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                const fechaInicio = primerDiaMes.toISOString().split('T')[0];
                const fechaFin = hoy.toISOString().split('T')[0];

                // Cargar datos reales
                const datosReales = await cargarDatosRealesInforme(fechaInicio, fechaFin);

                // Renderizar el informe con datos reales
                renderizarInformeConDatos(modalBody, datosReales, fechaInicio, fechaFin);

            } catch (error) {
                console.error('‚ùå Error cargando informe:', error);
                modalBody.innerHTML = `
            <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; margin: 20px;">
                <strong>‚ùå Error:</strong> No se pudo cargar el informe. ${error.message}
            </div>
        `;
            }
        }

        // Funci√≥n para cargar datos reales de Supabase
        async function cargarDatosRealesInforme(fechaInicio, fechaFin) {
            console.log('üìä Cargando datos reales...', { fechaInicio, fechaFin, tenant_id: userData.tenant_id });

            // Convertir fechas a formato ISO con hora
            const fechaInicioISO = new Date(fechaInicio + 'T00:00:00').toISOString();
            const fechaFinISO = new Date(fechaFin + 'T23:59:59').toISOString();

            // 1. CARGAR VENTAS
            const { data: ventas, error: errorVentas } = await supabase
                .from('ventas')
                .select('total, created_at')
                .eq('tenant_id', userData.tenant_id)
                .eq('activo', true)
                .gte('created_at', fechaInicioISO)
                .lte('created_at', fechaFinISO);

            if (errorVentas) throw new Error('Error cargando ventas: ' + errorVentas.message);

            // 2. CARGAR MOVIMIENTOS DE INVENTARIO (Mermas, Consumos, Compras)
            const { data: movimientos, error: errorMovimientos } = await supabase
                .from('movimientos_inventario')
                .select('codigo, costo_total, costo_unitario, cantidad, created_at')
                .eq('tenant_id', userData.tenant_id)
                .eq('activo', true)
                .gte('created_at', fechaInicioISO)
                .lte('created_at', fechaFinISO);

            if (errorMovimientos) throw new Error('Error cargando movimientos: ' + errorMovimientos.message);

            // 3. CARGAR GASTOS DE LA TABLA GASTOS
            const { data: gastos, error: errorGastos } = await supabase
                .from('gastos')
                .select('monto, concepto, tipo_gasto, created_at')
                .eq('tenant_id', userData.tenant_id)
                .eq('activo', true)
                .is('deleted_at', null)
                .gte('created_at', fechaInicioISO)
                .lte('created_at', fechaFinISO);

            if (errorGastos) throw new Error('Error cargando gastos: ' + errorGastos.message);

            console.log('‚úÖ Datos cargados:', {
                ventas: ventas.length,
                movimientos: movimientos.length,
                gastos: gastos.length
            });

            // CALCULAR TOTALES
            const totalVentas = ventas.reduce((sum, v) => sum + parseFloat(v.total || 0), 0);

            // Separar movimientos por tipo de c√≥digo
            const mermas = movimientos.filter(m => m.codigo && m.codigo.startsWith('M'));
            const consumos = movimientos.filter(m => m.codigo && m.codigo.startsWith('C'));
            const compras = movimientos.filter(m => m.codigo && m.codigo.startsWith('E'));

            // Calcular totales de movimientos
            const totalMermas = mermas.reduce((sum, m) => {
                const costoTotal = parseFloat(m.costo_total || 0);
                const costoCalculado = costoTotal > 0 ? costoTotal : (parseFloat(m.cantidad || 0) * parseFloat(m.costo_unitario || 0));
                return sum + costoCalculado;
            }, 0);

            const totalConsumos = consumos.reduce((sum, c) => {
                const costoTotal = parseFloat(c.costo_total || 0);
                const costoCalculado = costoTotal > 0 ? costoTotal : (parseFloat(c.cantidad || 0) * parseFloat(c.costo_unitario || 0));
                return sum + costoCalculado;
            }, 0);

            const totalCompras = compras.reduce((sum, c) => {
                const costoTotal = parseFloat(c.costo_total || 0);
                const costoCalculado = costoTotal > 0 ? costoTotal : (parseFloat(c.cantidad || 0) * parseFloat(c.costo_unitario || 0));
                return sum + costoCalculado;
            }, 0);

            // Separar gastos por tipo
            const gastosServicios = gastos.filter(g => g.tipo_gasto === 'servicios');
            const gastosNomina = gastos.filter(g => g.tipo_gasto === 'nomina');
            const gastosAlimentacion = gastos.filter(g => g.tipo_gasto === 'alimentacion');
            const gastosViaje = gastos.filter(g => g.tipo_gasto === 'viaje');
            const gastosDeuda = gastos.filter(g => g.tipo_gasto === 'deuda');
            const gastosEntretenimiento = gastos.filter(g => g.tipo_gasto === 'entretenimiento');
            const gastosVariable = gastos.filter(g => g.tipo_gasto === 'variable');

            // Calcular totales de gastos
            const totalServicios = gastosServicios.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const totalNomina = gastosNomina.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const totalAlimentacion = gastosAlimentacion.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const totalViaje = gastosViaje.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const totalDeuda = gastosDeuda.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const totalEntretenimiento = gastosEntretenimiento.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const totalVariable = gastosVariable.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);

            // Gastos Operacionales = Compras + Servicios + N√≥mina + Consumos
            const gastosOperacionales = totalCompras + totalServicios + totalNomina + totalConsumos;

            // Gastos Personales Externos = Alimentaci√≥n + Viaje + Deuda + Entretenimiento + Variable
            const gastosPersonalesExternos = totalAlimentacion + totalViaje + totalDeuda + totalEntretenimiento + totalVariable;

            // Gastos Totales = Operacionales + Personales + Mermas
            const gastosTotales = gastosOperacionales + gastosPersonalesExternos + totalMermas;

            // Utilidad = Ventas - Gastos
            const utilidadNeta = totalVentas - gastosTotales;

            // Margen de ganancia (%)
            const margenGanancia = totalVentas > 0 ? ((utilidadNeta / totalVentas) * 100).toFixed(1) : 0;

            console.log('üí∞ C√°lculos:', {
                totalVentas,
                gastosOperacionales: {
                    totalCompras,
                    totalServicios,
                    totalNomina,
                    totalConsumos,
                    total: gastosOperacionales
                },
                gastosPersonalesExternos: {
                    totalAlimentacion,
                    totalViaje,
                    totalDeuda,
                    totalEntretenimiento,
                    totalVariable,
                    total: gastosPersonalesExternos
                },
                totalMermas,
                gastosTotales,
                utilidadNeta,
                margenGanancia
            });

            return {
                totalVentas,
                // Gastos Operacionales
                totalCompras,
                totalServicios,
                totalNomina,
                totalConsumos,
                gastosOperacionales,
                // Gastos Personales Externos
                totalAlimentacion,
                totalViaje,
                totalDeuda,
                totalEntretenimiento,
                totalVariable,
                gastosPersonalesExternos,
                // Mermas
                totalMermas,
                // Totales generales
                gastosTotales,
                utilidadNeta,
                margenGanancia,
                // Contadores
                cantidadVentas: ventas.length,
                cantidadCompras: compras.length,
                cantidadServicios: gastosServicios.length,
                cantidadNomina: gastosNomina.length,
                cantidadConsumos: consumos.length,
                cantidadAlimentacion: gastosAlimentacion.length,
                cantidadViaje: gastosViaje.length,
                cantidadDeuda: gastosDeuda.length,
                cantidadEntretenimiento: gastosEntretenimiento.length,
                cantidadVariable: gastosVariable.length,
                cantidadMermas: mermas.length
            };
        }

        // Funci√≥n para renderizar el informe con los datos
        function renderizarInformeConDatos(modalBody, datos, fechaInicio, fechaFin) {
            const formatearMoneda = (valor) => {
                return new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0
                }).format(valor);
            };

            modalBody.innerHTML = `
    <div style="background: #f5f5f5; padding: 0; margin: 0; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div style="max-width: 100%; margin: 0; background: white; border-radius: 0; overflow: hidden; box-shadow: none;">
                
                <!-- Header del informe -->
                  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 5px;">üìä Informe de Ventas</h1>
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="font-size: 11px; opacity: 0.9;">Fecha Inicio:</label>
                            <input type="date" id="fechaInicioInforme" value="${fechaInicio}" style="padding: 5px 10px; border-radius: 5px; border: none; font-size: 13px;">
                        </div>
                        <div>
                            <label style="font-size: 11px; opacity: 0.9;">Fecha Fin:</label>
                            <input type="date" id="fechaFinInforme" value="${fechaFin}" style="padding: 5px 10px; border-radius: 5px; border: none; font-size: 13px;">
                        </div>
                    </div>
                    <button onclick="actualizarInforme()" style="margin-top: 10px; padding: 8px 20px; background: white; color: #667eea; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        üîÑ Actualizar
                    </button>
                    <p id="textoPeriodoInforme" style="margin-top: 10px;">Periodo seleccionado</p>
                </div>

                <div style="padding: 12px;">
                    <!-- Tarjetas de resumen -->
                    <div style="background: linear-gradient(135deg, #d4fc79 0%, #96f550 100%); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #10b981;">
                        <div style="font-size: 13px; font-weight: 600; color: #333; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 8px;">üí∞ Ventas Totales</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1f2937;">${formatearMoneda(datos.totalVentas)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">${datos.cantidadVentas} transacciones</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #3b82f6;">
                        <div style="font-size: 13px; font-weight: 600; color: #333; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 8px;">üìà Utilidades Netas</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1f2937;">${formatearMoneda(datos.utilidadNeta)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">${datos.margenGanancia}% margen de ganancia</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 12px; padding: 26px; margin-bottom: 12px; border-left: 5px solid #ef4444;">
                        <div style="font-size: 13px; font-weight: 600; color: #333; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 8px;">üí∏ Gastos Totales</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1f2937;">${formatearMoneda(datos.gastosTotales)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">Operacionales</div>
                    </div>

                    <!-- Desglose de Gastos Operacionales -->
${datos.gastosOperacionales > 0 ? `
    <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-top: 25px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">üíº Gastos Operacionales</div>

    ${datos.totalCompras > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üõí Costo Inventario</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalCompras)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadCompras} registros</div>
    ` : ''}

    ${datos.totalServicios > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üè¢ Servicios</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalServicios)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadServicios} registros</div>
    ` : ''}

    ${datos.totalNomina > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üë• N√≥mina/Sueldo Personal</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalNomina)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadNomina} registros</div>
    ` : ''}

    ${datos.totalConsumos > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üì¶ Consumo de Inventario a Costo</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalConsumos)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 15px;">${datos.cantidadConsumos} registros</div>
    ` : ''}

    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between;">
        <strong style="color: #0369a1;">Total Gastos Operacionales:</strong>
        <strong style="color: #0369a1;">${formatearMoneda(datos.gastosOperacionales)}</strong>
    </div>
</div>

` : ''}

<!-- Gastos Personales Externos -->
${datos.gastosPersonalesExternos > 0 ? `
    <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-top: 25px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">ÔøΩÔ∏è Gastos Personales Externos</div>

    ${datos.totalAlimentacion > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üçΩÔ∏è Alimentaci√≥n</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalAlimentacion)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadAlimentacion} registros</div>
    ` : ''}

    ${datos.totalViaje > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üöó Viaje</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalViaje)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadViaje} registros</div>
    ` : ''}

    ${datos.totalDeuda > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üí≥ Deuda Personal</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalDeuda)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadDeuda} registros</div>
    ` : ''}

    ${datos.totalEntretenimiento > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üéÆ Entretenimiento</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalEntretenimiento)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 10px;">${datos.cantidadEntretenimiento} registros</div>
    ` : ''}

    ${datos.totalVariable > 0 ? `
        <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 14px;">
            <span style="color: #666; font-weight: 500;">üìù Variables</span>
            <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalVariable)}</span>
        </div>
        <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 15px;">${datos.cantidadVariable} registros</div>
    ` : ''}

    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
<div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between;">
        <strong style="color: #92400e;">Total Gastos Personales:</strong>
        <strong style="color: #92400e;">${formatearMoneda(datos.gastosPersonalesExternos)}</strong>
    </div>
</div>

` : ''}

<!-- Mermas y P√©rdidas -->
${datos.totalMermas > 0 ? `
    <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-top: 25px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">‚ùå Mermas y P√©rdidas</div>

    <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 14px;">
        <span style="color: #666; font-weight: 500;">üìâ P√©rdidas por Merma</span>
        <span style="font-weight: 600; color: #1f2937;">${formatearMoneda(datos.totalMermas)}</span>
    </div>
    <div style="font-size: 11px; color: #888; padding-left: 10px; margin-bottom: 15px;">${datos.cantidadMermas} registros</div>
` : ''}

${(datos.gastosOperacionales > 0 || datos.gastosPersonalesExternos > 0 || datos.totalMermas > 0) ? `
    <div style="background: #eff6ff; border-left: 3px solid #3b82f6; padding: 10px 12px; border-radius: 6px; font-size: 12px; color: #1e40af; margin-top: 15px;">
        <strong>üí° Nota:</strong> Los gastos est√°n organizados en tres categor√≠as principales:<br>
        ‚Ä¢ <strong>Operacionales:</strong> Compras, servicios, n√≥mina y consumos<br>
        ‚Ä¢ <strong>Personales:</strong> Alimentaci√≥n, viaje, deuda, entretenimiento y variables<br>
        ‚Ä¢ <strong>Mermas:</strong> P√©rdidas de inventario
    </div>
` : ''}

                    <!-- Resumen Final -->
                    <div style="background: #f9fafb; border-radius: 10px; padding: 15px; margin-top: 20px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 14px;">
                            <strong style="color: #1f2937;">Ingresos Totales</strong>
                            <span style="color: #10b981; font-weight: 600;">+ ${formatearMoneda(datos.totalVentas)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 14px;">
                            <strong style="color: #1f2937;">Gastos Totales</strong>
                            <span style="color: #ef4444; font-weight: 600;">- ${formatearMoneda(datos.gastosTotales)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 14px; border-top: 2px solid #d1d5db; padding-top: 10px; margin-top: 10px;">
                            <strong style="color: #1f2937;">Utilidad Neta</strong>
                            <span style="color: ${datos.utilidadNeta >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 16px;">${formatearMoneda(datos.utilidadNeta)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 14px;">
                            <strong style="color: #1f2937;">Margen de Ganancia</strong>
                            <span style="color: #666;">${datos.margenGanancia}%</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f9fafb; padding: 15px 20px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #e5e7eb;">
                    <p>Informe generado: ${new Date().toLocaleString('es-CO')}</p>
                    <p>üè™ ${userData.tenants.nombre_negocio}</p>
                </div>
            </div>
          </div>
        </div>
    `;
        }

        // Funci√≥n para actualizar el informe cuando cambian las fechas
        async function actualizarInforme() {
            const fechaInicio = document.getElementById('fechaInicioInforme').value;
            const fechaFin = document.getElementById('fechaFinInforme').value;

            if (!fechaInicio || !fechaFin) {
                alert('Por favor selecciona ambas fechas');
                return;
            }

            if (new Date(fechaInicio) > new Date(fechaFin)) {
                alert('La fecha de inicio no puede ser mayor a la fecha fin');
                return;
            }

            const modalBody = document.getElementById('modalBodyInformes');
            await cargarInformes(modalBody);
        }

        // =====================================================
        // FUNCIONES PARA EDITAR PRODUCTO
        // =====================================================

        async function cargarFormularioEditarProducto(modalBody) {
            // Mostrar loading
            modalBody.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <p>Cargando productos...</p>
        </div>
    `;

            try {
                // Cargar productos
                const { data: productos, error } = await supabase
                    .from('productos')
                    .select('producto_id, codigo, producto')
                    .eq('tenant_id', userData.tenant_id)
                    .eq('activo', true)
                    .order('codigo');

                if (error) throw error;

                modalBody.innerHTML = `
            <div id="successEditProducto" class="success-message"></div>
            <div id="errorEditProducto" class="error"></div>
            
            <!-- Buscador -->
            <div class="form-group">
                <label for="buscarProductoEdit">Buscar producto</label>
                <input 
                    type="text" 
                    id="buscarProductoEdit" 
                    placeholder="Buscar por c√≥digo o nombre..."
                    onkeyup="filtrarProductosEdit()"
                >
            </div>
            
            <!-- Tabla de productos -->
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="productos-table" id="tablaProductosEdit">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="bodyProductosEdit">
                        ${productos.map(p => `
                            <tr data-producto-id="${p.producto_id}">
                                <td><strong>${p.codigo}</strong></td>
                                <td id="nombre-${p.producto_id}">${p.producto}</td>
                                <td>
                                    <button 
                                        onclick="editarNombreProducto('${p.producto_id}', '${p.codigo}')"
                                        style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;"
                                    >
                                        ‚úèÔ∏è Editar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

            } catch (error) {
                console.error('Error cargando productos:', error);
                modalBody.innerHTML = `
            <div class="error show">
                Error al cargar productos: ${error.message}
            </div>
        `;
            }
        }

        // Filtrar productos en la tabla
        function filtrarProductosEdit() {
            const input = document.getElementById('buscarProductoEdit');
            const filter = input.value.toLowerCase();
            const tbody = document.getElementById('bodyProductosEdit');
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const codigo = rows[i].cells[0].textContent.toLowerCase();
                const nombre = rows[i].cells[1].textContent.toLowerCase();

                if (codigo.includes(filter) || nombre.includes(filter)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        // Editar nombre de producto
        async function editarNombreProducto(productoId, codigo) {
            const nombreActual = document.getElementById(`nombre-${productoId}`).textContent;

            const nuevoNombre = prompt(`Editar nombre del producto [${codigo}]:\n\nNombre actual: ${nombreActual}\n\nIngresa el nuevo nombre:`, nombreActual);

            if (!nuevoNombre || nuevoNombre.trim() === '') {
                return;
            }

            if (nuevoNombre.trim() === nombreActual) {
                alert('El nombre no ha cambiado');
                return;
            }

            try {
                const { error } = await supabase
                    .from('productos')
                    .update({
                        producto: nuevoNombre.trim(),
                        updated_at: new Date().toISOString(),
                        updated_by: userData.user_id
                    })
                    .eq('producto_id', productoId);

                if (error) throw error;

                // Actualizar en la tabla
                document.getElementById(`nombre-${productoId}`).textContent = nuevoNombre.trim();

                mostrarExitoEditProducto(`‚úÖ Producto actualizado correctamente\n\n[${codigo}] ${nuevoNombre.trim()}`);

            } catch (error) {
                console.error('Error actualizando producto:', error);
                mostrarErrorEditProducto('Error al actualizar el producto: ' + error.message);
            }
        }

        function mostrarErrorEditProducto(mensaje) {
            const errorDiv = document.getElementById('errorEditProducto');
            const successDiv = document.getElementById('successEditProducto');

            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.classList.add('show');
            }
            if (successDiv) {
                successDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (errorDiv) errorDiv.classList.remove('show');
            }, 5000);
        }

        function mostrarExitoEditProducto(mensaje) {
            const successDiv = document.getElementById('successEditProducto');
            const errorDiv = document.getElementById('errorEditProducto');

            if (successDiv) {
                successDiv.textContent = mensaje;
                successDiv.classList.add('show');
            }
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (successDiv) successDiv.classList.remove('show');
            }, 3000);
        }

        // =====================================================
        async function cargarFormularioEditarApodos(modalBody) {
            modalBody.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <p>Cargando productos...</p>
        </div>
    `;

            try {
                // Cargar productos con sus apodos
                const { data: productos, error } = await supabase
                    .from('productos')
                    .select(`
                producto_id,
                codigo,
                producto
            `)
                    .eq('tenant_id', userData.tenant_id)
                    .eq('activo', true)
                    .order('codigo');

                if (error) throw error;

                modalBody.innerHTML = `
            <div id="successEditApodos" class="success-message"></div>
            <div id="errorEditApodos" class="error"></div>
            
            <div class="form-group">
                <label for="buscarProductoApodos">Buscar producto</label>
                <input 
                    type="text" 
                    id="buscarProductoApodos" 
                    placeholder="Buscar por c√≥digo o nombre..."
                    onkeyup="filtrarProductosApodos()"
                >
            </div>
            
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="productos-table" id="tablaProductosApodos">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Producto</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="bodyProductosApodos">
                        ${productos.map(p => `
                            <tr>
                                <td><strong>${p.codigo}</strong></td>
                                <td>${p.producto}</td>
                                <td>
                                    <button 
                                        onclick="abrirEditorApodos('${p.producto_id}', '${p.codigo}', \`${p.producto}\`)"
                                        style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;"
                                    >
                                        üè∑Ô∏è Editar Apodos
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- Secci√≥n del editor de apodos (oculta inicialmente) -->
            
                
                <!-- Lista de apodos existentes -->
                <div id="listaApodos" style="margin-bottom: 20px;">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
                
                <!-- Agregar nuevo apodo -->
                <div style="background: #f5f7ff; padding: 15px; border-radius: 8px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Agregar nuevo apodo</label>
                <div style="display: flex; gap: 10px; align-items: center;">
    <input 
        type="text" 
        id="nuevoApodo" 
        placeholder="Escribe el nuevo apodo..."
        style="flex: 1; padding: 10px 12px; max-width: 70%;"
        onkeypress="if(event.key === 'Enter') agregarNuevoApodo()"
    >
    <button 
        onclick="agregarNuevoApodo()"
        style="padding: 10px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; min-width: auto; width: auto; flex-shrink: 0;"
    >
        ‚ûï
    </button>
</div>
                </div>
            </div>
        `;

            } catch (error) {
                console.error('Error cargando productos:', error);
                modalBody.innerHTML = `
            <div class="error show">
                Error al cargar productos: ${error.message}
            </div>
        `;
            }
        }

        // Variable global para el producto actual
        let productoActualApodos = null;

        // Filtrar productos en la tabla
        function filtrarProductosApodos() {
            const input = document.getElementById('buscarProductoApodos');
            const filter = input.value.toLowerCase();
            const tbody = document.getElementById('bodyProductosApodos');
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const codigo = rows[i].cells[0].textContent.toLowerCase();
                const producto = rows[i].cells[1].textContent.toLowerCase();

                if (codigo.includes(filter) || producto.includes(filter)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        async function abrirEditorApodos(productoId, codigo, producto) {
            productoActualApodos = { producto_id: productoId, codigo: codigo, producto: producto };

            // Actualizar t√≠tulo del modal
            document.getElementById('tituloModalEditorApodos').textContent = `üè∑Ô∏è [${codigo}] ${producto}`;

            // Abrir el nuevo modal
            const modal = document.getElementById('modalEditorApodos');
            const modalBody = document.getElementById('modalBodyEditorApodos');

            // Mostrar loading
            modalBody.innerHTML = '<p style="text-align: center; padding: 40px;">Cargando apodos...</p>';

            modal.classList.add('show');

            // Cargar contenido del editor
            await cargarContenidoEditorApodos(productoId);
        }

        async function cargarContenidoEditorApodos(productoId) {
            const modalBody = document.getElementById('modalBodyEditorApodos');

            try {
                const { data: apodos, error } = await supabase
                    .from('productos_apodos')
                    .select('apodo_id, apodo')
                    .eq('producto_id', productoId)
                    .eq('tenant_id', userData.tenant_id)
                    .is('deleted_at', null)
                    .order('apodo');

                if (error) throw error;

                let listaApodosHTML = '';

                if (apodos.length === 0) {
                    listaApodosHTML = `
                <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px; color: #999; margin-bottom: 20px;">
                    No hay apodos registrados para este producto
                </div>
            `;
                } else {
                    listaApodosHTML = `
                <div style="background: #fff; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Apodos actuales:</h4>
                    <div id="apodosItems">
                        ${apodos.map(a => `
                            <div id="apodo-item-${a.apodo_id}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f7ff; border-radius: 6px; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #333;">üè∑Ô∏è ${a.apodo}</span>
                                <button 
                                    onclick="eliminarApodoEditor('${a.apodo_id}', '${a.apodo}')"
                                    style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; min-width: auto; width: auto; flex-shrink: 0;"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
                }

                modalBody.innerHTML = `
            <div id="successEditApodosModal" class="success-message"></div>
            <div id="errorEditApodosModal" class="error"></div>
            
            ${listaApodosHTML}
            
            <!-- Agregar nuevo apodo -->
            <div style="background: #f5f7ff; padding: 15px; border-radius: 8px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Agregar nuevo apodo</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input 
                        type="text" 
                        id="nuevoApodoModal" 
                        placeholder="Escribe el nuevo apodo..."
                        style="flex: 1; padding: 10px 12px; max-width: 70%;"
                        onkeypress="if(event.key === 'Enter') agregarNuevoApodoModal()"
                    >
                    <button 
                        onclick="agregarNuevoApodoModal()"
                        style="padding: 10px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; min-width: auto; width: auto; flex-shrink: 0;"
                    >
                        ‚ûï
                    </button>
                </div>
            </div>
        `;

            } catch (error) {
                console.error('Error cargando apodos:', error);
                modalBody.innerHTML = `
            <div class="error show">
                Error al cargar apodos: ${error.message}
            </div>
        `;
            }
        }

        // Agregar nuevo apodo
        async function agregarNuevoApodoModal() {
            const input = document.getElementById('nuevoApodoModal');
            const apodo = input.value.trim();

            if (!apodo) {
                mostrarErrorEditApodosModal('Debes escribir un apodo');
                return;
            }

            if (!productoActualApodos) {
                mostrarErrorEditApodosModal('No hay producto seleccionado');
                return;
            }

            try {
                // Insertar nuevo apodo
                const { data, error } = await supabase
                    .from('productos_apodos')
                    .insert({
                        tenant_id: userData.tenant_id,
                        producto_id: productoActualApodos.producto_id,
                        apodo: apodo.toLowerCase(),
                        producto: productoActualApodos.producto
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Limpiar input
                input.value = '';

                // Recargar lista de apodos
                await cargarContenidoEditorApodos(productoActualApodos.producto_id);

                mostrarExitoEditApodosModal(`‚úÖ Apodo "${apodo}" agregado correctamente`);

            } catch (error) {
                console.error('Error agregando apodo:', error);
                mostrarErrorEditApodosModal('Error al agregar apodo: ' + error.message);
            }
        }

        // Eliminar apodo desde el editor
        async function eliminarApodoEditor(apodoId, apodo) {
            if (!confirm(`¬øSeguro que deseas eliminar el apodo "${apodo}"?`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('productos_apodos')
                    .delete()
                    .eq('apodo_id', apodoId);

                if (error) throw error;

                // Eliminar visualmente
                const item = document.getElementById(`apodo-item-${apodoId}`);
                if (item) item.remove();

                // Si ya no quedan apodos, recargar para mostrar mensaje
                const apodosItems = document.getElementById('apodosItems');
                if (apodosItems && apodosItems.children.length === 0) {
                    await cargarContenidoEditorApodos(productoActualApodos.producto_id);
                }

                mostrarExitoEditApodosModal(`‚úÖ Apodo "${apodo}" eliminado correctamente`);

            } catch (error) {
                console.error('Error eliminando apodo:', error);
                mostrarErrorEditApodosModal('Error al eliminar apodo: ' + error.message);
            }
        }

        // Cerrar editor de apodos
        function cerrarModalEditorApodos() {
            document.getElementById('modalEditorApodos').classList.remove('show');
            productoActualApodos = null;
        }

        function mostrarErrorEditApodosModal(mensaje) {
            const errorDiv = document.getElementById('errorEditApodosModal');
            const successDiv = document.getElementById('successEditApodosModal');

            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.classList.add('show');
            }
            if (successDiv) {
                successDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (errorDiv) errorDiv.classList.remove('show');
            }, 5000);
        }

        function mostrarExitoEditApodosModal(mensaje) {
            const successDiv = document.getElementById('successEditApodosModal');
            const errorDiv = document.getElementById('errorEditApodosModal');

            if (successDiv) {
                successDiv.textContent = mensaje;
                successDiv.classList.add('show');
            }
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (successDiv) successDiv.classList.remove('show');
            }, 3000);
        }

        function filtrarApodosEdit() {
            const input = document.getElementById('buscarApodoEdit');
            const filter = input.value.toLowerCase();
            const tbody = document.getElementById('bodyApodosEdit');
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const codigo = rows[i].cells[0].textContent.toLowerCase();
                const producto = rows[i].cells[1].textContent.toLowerCase();
                const apodo = rows[i].cells[2].textContent.toLowerCase();

                if (codigo.includes(filter) || producto.includes(filter) || apodo.includes(filter)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        async function eliminarApodo(apodoId, codigo, apodo) {
            if (!confirm(`¬øSeguro que deseas eliminar el apodo "${apodo}" del producto [${codigo}]?`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('productos_apodos')
                    .delete()
                    .eq('apodo_id', apodoId);

                if (error) throw error;

                // Eliminar fila de la tabla
                const row = document.querySelector(`tr[data-apodo-id="${apodoId}"]`);
                if (row) row.remove();

                mostrarExitoEditApodosModal(`‚úÖ Apodo eliminado correctamente\n\n[${codigo}] "${apodo}"`);

            } catch (error) {
                console.error('Error eliminando apodo:', error);
                mostrarErrorEditApodosModal('Error al eliminar apodo: ' + error.message);
            }
        }

        function mostrarErrorEditApodosModal(mensaje) {
            const errorDiv = document.getElementById('errorEditApodos');
            const successDiv = document.getElementById('successEditApodos');

            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.classList.add('show');
            }
            if (successDiv) {
                successDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (errorDiv) errorDiv.classList.remove('show');
            }, 5000);
        }

        function mostrarExitoEditApodosModal(mensaje) {
            const successDiv = document.getElementById('successEditApodos');
            const errorDiv = document.getElementById('errorEditApodos');

            if (successDiv) {
                successDiv.textContent = mensaje;
                successDiv.classList.add('show');
            }
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }

            setTimeout(() => {
                if (successDiv) successDiv.classList.remove('show');
            }, 3000);
        }

        // =====================================================
        // FUNCIONES PARA PRODUCTOS PROCESADOS
        // =====================================================

        let ingredientesReceta = [];

        // Seleccionar tipo de producto
        function seleccionarTipoProducto(tipo, elemento) {
            // Remover clase selected de todos
            document.querySelectorAll('.tipo-producto-option').forEach(el => {
                el.classList.remove('selected');
            });

            // Agregar clase al seleccionado
            elemento.classList.add('selected');

            // Marcar el radio
            document.getElementById(tipo === 'simple' ? 'tipoSimple' : 'tipoProcesado').checked = true;

            // Mostrar/ocultar secci√≥n de receta
            const seccionReceta = document.getElementById('seccionReceta');
            if (tipo === 'procesado') {
                seccionReceta.classList.add('active');
                cargarProductosParaReceta();
            } else {
                seccionReceta.classList.remove('active');
                ingredientesReceta = [];
            }
        }

        // Cargar productos disponibles para la receta
        async function cargarProductosParaReceta() {
            try {
                const { data: productos, error } = await supabase
                    .from('productos')
                    .select('producto_id, codigo, producto, tipo_venta, unidad_venta')
                    .eq('tenant_id', userData.tenant_id)
                    .eq('activo', true)
                    .order('producto');

                if (error) throw error;

                const select = document.getElementById('selectIngrediente');
                select.innerHTML = '<option value="">Seleccionar ingrediente...</option>';

                productos.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.producto_id;
                    option.textContent = `[${p.codigo}] ${p.producto}`;
                    option.dataset.unidad = p.unidad_venta || 'unidades';
                    option.dataset.tipoVenta = p.tipo_venta;
                    option.dataset.codigo = p.codigo;
                    option.dataset.nombre = p.producto;
                    select.appendChild(option);
                });

                // Listener para actualizar opciones de unidad
                select.addEventListener('change', function () {
                    const selectedOption = this.options[this.selectedIndex];
                    const selectUnidad = document.getElementById('unidadIngrediente');

                    if (selectedOption.value) {
                        const tipoVenta = selectedOption.dataset.tipoVenta;
                        const unidadBase = selectedOption.dataset.unidad;

                        selectUnidad.innerHTML = '';

                        if (tipoVenta === 'peso') {
                            // Opciones para productos de peso
                            selectUnidad.innerHTML = `
                <option value="gramos">Gramos</option>
                <option value="kilogramos">Kilogramos</option>
                <option value="libras" selected>Libras</option>
                <option value="onzas">Onzas</option>
            `;
                        } else if (tipoVenta === 'medida') {
                            // Opciones para productos de medida
                            selectUnidad.innerHTML = `
                <option value="milimetros">Mil√≠metros</option>
                <option value="centimetros">Cent√≠metros</option>
                <option value="metros" selected>Metros</option>
            `;
                        } else {
                            // Para unidades (tipo unidad)
                            selectUnidad.innerHTML = `
                <option value="unidades" selected>Unidades</option>
            `;
                        }
                    } else {
                        selectUnidad.innerHTML = '<option value="">Selecciona ingrediente primero</option>';
                    }
                });

            } catch (error) {
                console.error('Error cargando productos:', error);
                alert('Error al cargar ingredientes disponibles');
            }
        }

        // Agregar ingrediente a la receta
        function agregarIngredienteReceta() {
            const select = document.getElementById('selectIngrediente');
            const cantidad = document.getElementById('cantidadIngrediente');
            const unidad = document.getElementById('unidadIngrediente');

            if (!select.value) {
                alert('Selecciona un ingrediente');
                return;
            }

            if (!cantidad.value || parseFloat(cantidad.value) <= 0) {
                alert('Ingresa una cantidad v√°lida');
                return;
            }

            const selectedOption = select.options[select.selectedIndex];

            // Verificar si ya existe
            if (ingredientesReceta.find(i => i.ingrediente_id === select.value)) {
                alert('Este ingrediente ya est√° en la receta');
                return;
            }

            // Agregar al array
            ingredientesReceta.push({
                ingrediente_id: select.value,
                codigo: selectedOption.dataset.codigo,
                nombre: selectedOption.dataset.nombre,
                cantidad: parseFloat(cantidad.value),
                unidad: unidad.value
            });

            // Limpiar campos
            select.value = '';
            cantidad.value = '';
            unidad.value = '';

            // Renderizar lista
            renderizarIngredientesReceta();
        }

        // Renderizar lista de ingredientes
        function renderizarIngredientesReceta() {
            const container = document.getElementById('listaIngredientes');

            if (ingredientesReceta.length === 0) {
                container.innerHTML = '<div class="empty-receta">No hay ingredientes agregados a√∫n</div>';
                document.getElementById('ingredientesReceta').value = '';
                return;
            }

            container.innerHTML = ingredientesReceta.map((ing, index) => `
        <div class="ingrediente-item">
            <div class="ingrediente-info">
                <div class="ingrediente-nombre">[${ing.codigo}] ${ing.nombre}</div>
                <div class="ingrediente-cantidad">${ing.cantidad} ${ing.unidad}</div>
            </div>
            <button type="button" class="btn-remove-ingrediente" onclick="eliminarIngredienteReceta(${index})">
                üóëÔ∏è Eliminar
            </button>
        </div>
    `).join('');

            // Actualizar input oculto
            document.getElementById('ingredientesReceta').value = JSON.stringify(ingredientesReceta);
        }

        // Eliminar ingrediente de la receta
        function eliminarIngredienteReceta(index) {
            ingredientesReceta.splice(index, 1);
            renderizarIngredientesReceta();
        }

        // =====================================================
        // FUNCIONES PARA CHAT ASISTENTE
        // =====================================================

        let mediaRecorder = null;
        let audioChunks = [];
        let estaGrabando = false;

        // Abrir modal de chat
        function abrirModalChat() {
            const modal = document.getElementById('modalChatAsistente');
            const chatMessages = document.getElementById('chatMessages');

            // Limpiar mensajes anteriores
            chatMessages.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #999;">
            <p style="font-size: 48px; margin-bottom: 10px;">üí¨</p>
            <p>¬°Hola! Soy tu asistente virtual.</p>
            <p style="font-size: 12px;">Env√≠a un mensaje de texto o presiona el micr√≥fono para hablar.</p>
        </div>
    `;

            modal.classList.add('show');

            // Configurar bot√≥n de micr√≥fono despu√©s de abrir el modal
            setTimeout(() => {
                const btnMicrofono = document.getElementById('btnGrabarVoz');
                if (btnMicrofono) {
                    configurarBotonMicrofono(btnMicrofono);
                }
            }, 100);
        }

        // Cerrar modal
        function closeModalChat() {
            if (estaGrabando) {
                detenerGrabacion();
            }
            document.getElementById('modalChatAsistente').classList.remove('show');
        }

        // Alternar entre bot√≥n micr√≥fono y enviar
        function toggleInputButtons() {
            const input = document.getElementById('inputMensajeChat');
            const btnMicrofono = document.getElementById('btnGrabarVoz');
            const btnEnviar = document.getElementById('btnEnviarMensaje');

            if (input.value.trim().length > 0) {
                btnMicrofono.style.display = 'none';
                btnEnviar.style.display = 'flex';
            } else {
                btnMicrofono.style.display = 'flex';
                btnEnviar.style.display = 'none';
            }
        }

        // Enviar mensaje de texto
        async function enviarMensajeChat() {
            const input = document.getElementById('inputMensajeChat');
            const mensaje = input.value.trim();

            if (!mensaje) return;

            // Limpiar input
            input.value = '';
            toggleInputButtons();

            // Mostrar mensaje del usuario
            agregarMensaje(mensaje, 'usuario');

            // Mostrar indicador de escritura
            mostrarIndicadorEscritura();

            try {
                // Enviar al webhook
                const response = await fetch('https://n8n-n8n.aa7tej.easypanel.host/webhook/chat-panel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mensaje: mensaje,
                        tipo: 'texto',
                        usuario: userData.nombre,
                        tenant_id: userData.tenant_id,
                        user_id: userData.user_id,
                        sessionid: `panel_${userData.user_id}`
                    })
                });

                const data = await response.json();

                // Quitar indicador de escritura
                quitarIndicadorEscritura();

                // Mostrar respuesta
                if (data.respuesta) {
                    agregarMensaje(data.respuesta, 'asistente');
                } else {
                    agregarMensaje('Lo siento, no pude procesar tu mensaje.', 'asistente');
                }

            } catch (error) {
                console.error('Error enviando mensaje:', error);
                quitarIndicadorEscritura();
                agregarMensaje('Error al enviar el mensaje. Intenta nuevamente.', 'asistente');
            }
        }

        // Agregar mensaje al chat
        function agregarMensaje(texto, tipo) {
            const chatMessages = document.getElementById('chatMessages');

            // Eliminar mensaje de bienvenida si existe
            const bienvenida = chatMessages.querySelector('[style*="text-align: center"]');
            if (bienvenida) bienvenida.remove();

            const timestamp = new Date().toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Formatear el texto si es del asistente
            let textoFormateado = texto;
            if (tipo === 'asistente') {
                // Detectar si es un mensaje de confirmaci√≥n de venta
                if (texto.includes('Registro de ventas')) {
                    textoFormateado = formatearMensajeVenta(texto);
                } else {
                    // Mensaje normal: solo saltos de l√≠nea
                    textoFormateado = texto.replace(/\n/g, '<br>');
                }
            }

            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = `mensaje-chat mensaje-${tipo}`;
            mensajeDiv.innerHTML = `
        <div class="mensaje-contenido">
            ${textoFormateado}
            <div class="mensaje-timestamp">${timestamp}</div>
        </div>
    `;

            chatMessages.appendChild(mensajeDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Formatear mensaje de venta estilo WhatsApp
        function formatearMensajeVenta(texto) {
            let html = '';
            const lineas = texto.split('\n');

            lineas.forEach((linea, index) => {
                linea = linea.trim();
                if (!linea) return;

                // Primera l√≠nea: Etiqueta verde
                if (linea.includes('Registro de ventas')) {
                    html += '<span class="etiqueta-registro">Registro de ventas</span><br>';
                    return;
                }

                // Fecha/hora
                if (linea.match(/\d{2}\/\d{2}\/\d{4}/)) {
                    html += `<div style="font-size: 12px; color: #666; margin-bottom: 8px;">${linea}</div>`;
                    return;
                }

                // L√≠neas de productos [V036]
                if (linea.match(/\[V\d+\]/)) {
                    const codigoMatch = linea.match(/(\[V\d+\])/);
                    const restoDeLaLinea = linea.replace(codigoMatch[0], '').trim();
                    html += `<div class="linea-venta"><span class="codigo-producto">${codigoMatch[0]}</span> ${restoDeLaLinea}</div>`;
                    return;
                }

                // Ingredientes descontados
                if (linea.includes('Ingredientes descontados:')) {
                    html += '<div class="seccion-ingredientes">üì¶ Ingredientes descontados:</div>';
                    return;
                }

                // Items de ingredientes
                if (linea.match(/^[‚Ä¢¬∑-]/)) {
                    html += `<div style="font-size: 12px; color: #666; margin-left: 8px;">${linea}</div>`;
                    return;
                }

                // Total de la venta
                if (linea.includes('Total de la venta:')) {
                    const precioMatch = linea.match(/\$[\d.,]+/);
                    if (precioMatch) {
                        html += `<div style="margin-top: 10px; font-weight: 600;">üí∞ Total: <span class="precio-total">${precioMatch[0]}</span></div>`;
                    }
                    return;
                }

                // Caja esperada
                if (linea.includes('Caja esperada:')) {
                    const precioMatch = linea.match(/\$[\d.,]+/);
                    if (precioMatch) {
                        html += `<div style="font-weight: 600;">üíº Caja: <span class="precio-total">${precioMatch[0]}</span></div>`;
                    }
                    return;
                }

                // Cualquier otra l√≠nea
                html += `<div>${linea}</div>`;
            });

            return html;
        }

        // Mostrar indicador de escritura
        function mostrarIndicadorEscritura() {
            const chatMessages = document.getElementById('chatMessages');
            const indicador = document.createElement('div');
            indicador.id = 'typingIndicator';
            indicador.className = 'mensaje-chat mensaje-asistente';
            indicador.innerHTML = `
        <div class="mensaje-contenido">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
            chatMessages.appendChild(indicador);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Quitar indicador de escritura
        function quitarIndicadorEscritura() {
            const indicador = document.getElementById('typingIndicator');
            if (indicador) indicador.remove();
        }

        // Manejar carga de imagen
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB l√≠mite
                    alert('La imagen es muy grande. M√°ximo 5MB.');
                    return;
                }
                enviarImagenChat(file);
                event.target.value = ''; // Reset input
            }
        }

        // Toggle grabaci√≥n de voz
        async function toggleGrabacion() {
            if (estaGrabando) {
                detenerGrabacion();
            } else {
                iniciarGrabacion();
            }
        }

        // Variables para grabaci√≥n por presi√≥n
        let grabacionTimer = null;
        let grabacionIniciada = false;

        // Configurar eventos del bot√≥n micr√≥fono
        document.addEventListener('DOMContentLoaded', () => {
            // ... c√≥digo existente ...

            // Configurar bot√≥n de micr√≥fono para mantener presionado
            setTimeout(() => {
                const btnMicrofono = document.getElementById('btnGrabarVoz');
                if (btnMicrofono) {
                    configurarBotonMicrofono(btnMicrofono);
                }
            }, 1000);
        });

        function configurarBotonMicrofono(btn) {
            // Touch events para m√≥vil
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                iniciarGrabacionPresionado();
            }, { passive: false });

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                detenerGrabacionPresionado();
            }, { passive: false });

            btn.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                detenerGrabacionPresionado();
            }, { passive: false });

            // Mouse events para desktop
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                iniciarGrabacionPresionado();
            });

            btn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                detenerGrabacionPresionado();
            });

            btn.addEventListener('mouseleave', (e) => {
                if (estaGrabando) {
                    detenerGrabacionPresionado();
                }
            });
        }

        // Iniciar grabaci√≥n al presionar
        async function iniciarGrabacionPresionado() {
            if (estaGrabando) return;

            const btn = document.getElementById('btnGrabarVoz');
            const estado = document.getElementById('estadoGrabacion');

            // Feedback visual inmediato
            btn.style.transform = 'scale(0.9)';
            btn.style.boxShadow = '0 1px 3px rgba(102, 126, 234, 0.3)';

            // Mostrar estado
            estado.style.display = 'block';
            estado.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            estado.style.color = 'white';
            estado.innerHTML = 'üé§ Grabando... Suelta para enviar';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    // Detener tracks
                    stream.getTracks().forEach(track => track.stop());

                    // Solo enviar si hay audio grabado
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        // Solo enviar si la grabaci√≥n dur√≥ m√°s de 0.5 segundos
                        if (audioBlob.size > 1000) {
                            await enviarAudioChat(audioBlob);
                        }
                    }

                    audioChunks = [];
                };

                mediaRecorder.start();
                estaGrabando = true;
                grabacionIniciada = true;

                // Cambiar √≠cono
                btn.innerHTML = '‚èπÔ∏è';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

            } catch (error) {
                console.error('Error accediendo al micr√≥fono:', error);
                estado.style.display = 'block';
                estado.style.background = '#fee';
                estado.style.color = '#c33';
                estado.textContent = '‚ùå No se pudo acceder al micr√≥fono';

                // Restaurar bot√≥n
                btn.style.transform = 'scale(1)';
                btn.innerHTML = 'üé§';

                setTimeout(() => {
                    estado.style.display = 'none';
                }, 3000);
            }
        }

        // Detener grabaci√≥n al soltar
        function detenerGrabacionPresionado() {
            if (!estaGrabando) return;

            const btn = document.getElementById('btnGrabarVoz');
            const estado = document.getElementById('estadoGrabacion');

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }

            estaGrabando = false;
            grabacionIniciada = false;

            // Restaurar bot√≥n
            btn.style.transform = 'scale(1)';
            btn.style.boxShadow = '0 2px 5px rgba(102, 126, 234, 0.3)';
            btn.innerHTML = 'üé§';
            btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

            // Ocultar estado
            setTimeout(() => {
                estado.style.display = 'none';
            }, 300);
        }

        // Mantener compatibilidad con funci√≥n anterior (por si acaso)
        async function toggleGrabacion() {
            // Esta funci√≥n ya no se usa, pero la dejamos por compatibilidad
            if (estaGrabando) {
                detenerGrabacionPresionado();
            } else {
                iniciarGrabacionPresionado();
            }
        }

        // Enviar imagen al webhook
        async function enviarImagenChat(imageFile) {
            agregarMensaje('üñºÔ∏è Imagen enviada', 'usuario');
            mostrarIndicadorEscritura();

            try {
                const reader = new FileReader();
                reader.readAsDataURL(imageFile);

                reader.onloadend = async () => {
                    const base64Image = reader.result.split(',')[1];

                    const response = await fetch('https://n8n-n8n.aa7tej.easypanel.host/webhook/chat-panel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            imagen: base64Image,
                            tipo: 'imagen',
                            usuario: userData.nombre,
                            tenant_id: userData.tenant_id,
                            user_id: userData.user_id,
                            sessionid: `panel_${userData.user_id}`
                        })
                    });

                    const data = await response.json();
                    quitarIndicadorEscritura();

                    if (data.respuesta) {
                        agregarMensaje(data.respuesta, 'asistente');
                    } else {
                        agregarMensaje('No pude procesar la imagen.', 'asistente');
                    }
                };

            } catch (error) {
                console.error('Error enviando imagen:', error);
                quitarIndicadorEscritura();
                agregarMensaje('Error al procesar la imagen.', 'asistente');
            }
        }

        // Enviar audio al webhook
        async function enviarAudioChat(audioBlob) {
            agregarMensaje('üé§ Audio enviado', 'usuario');
            mostrarIndicadorEscritura();

            try {
                // Convertir blob a base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1];

                    const response = await fetch('https://n8n-n8n.aa7tej.easypanel.host/webhook/chat-panel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            audio: base64Audio,
                            tipo: 'audio',
                            usuario: userData.nombre,
                            tenant_id: userData.tenant_id,
                            user_id: userData.user_id,
                            sessionid: `panel_${userData.user_id}`
                        })
                    });

                    const data = await response.json();
                    quitarIndicadorEscritura();

                    if (data.respuesta) {
                        agregarMensaje(data.respuesta, 'asistente');
                    } else {
                        agregarMensaje('No pude procesar el audio.', 'asistente');
                    }
                };

            } catch (error) {
                console.error('Error enviando audio:', error);
                quitarIndicadorEscritura();
                agregarMensaje('Error al procesar el audio.', 'asistente');
            }
        }

        // =====================================================
        // FUNCIONES PARA MODAL DE MESAS
        // =====================================================

        let mesasData = [];
        let mesaCounter = 0;
        let grabacionActivaMesas = false;
        let mesaGrabandoId = null;
        let mediaRecorderMesas = null;
        let audioChunksMesas = [];

        // Abrir modal de mesas
        async function abrirModalMesas() {
            const modal = document.getElementById('modalMesas');
            modal.classList.add('show');

            // Cargar mesas desde localStorage o crear inicial
            const mesasGuardadas = localStorage.getItem(`mesas_${userData.tenant_id}`);
            if (mesasGuardadas) {
                mesasData = JSON.parse(mesasGuardadas);
                mesaCounter = Math.max(...mesasData.map(m => m.id), 0);
            } else {
                mesasData = [];
                mesaCounter = 0;
            }

            renderMesas();

            // Re-renderizar al cambiar tama√±o de ventana
            window.addEventListener('resize', () => {
                if (document.getElementById('modalMesas').classList.contains('show')) {
                    renderMesas();
                }
            });
        }

        // Guardar mesas en localStorage
        function guardarMesas() {
            localStorage.setItem(`mesas_${userData.tenant_id}`, JSON.stringify(mesasData));
        }

        // Calcular total de una mesa
        function calcularTotalMesa(productos) {
            return productos.reduce((sum, p) => sum + p.precio_total, 0);
        }

        // Formatear precio
        function formatPrecioMesa(precio) {
            return `$${Math.round(precio).toLocaleString('es-CO')}`;
        }

        // Cambiar cantidad de producto
        function cambiarCantidadMesa(mesaId, productoIdx, delta) {
            const mesa = mesasData.find(m => m.id === mesaId);
            const producto = mesa.productos[productoIdx];

            const nuevaCantidad = Math.max(0.01, producto.cantidad + delta);
            producto.cantidad = nuevaCantidad;
            producto.precio_total = producto.precio_unitario * nuevaCantidad;

            guardarMesas();
            renderMesas();
        }

        // Eliminar producto de mesa
        function eliminarProductoMesa(mesaId, productoIdx) {
            const mesa = mesasData.find(m => m.id === mesaId);
            mesa.productos.splice(productoIdx, 1);
            guardarMesas();
            renderMesas();
        }

        // Eliminar mesa completa
        function eliminarMesa(mesaId) {
            if (confirm('¬øSeguro que deseas eliminar esta mesa?')) {
                mesasData = mesasData.filter(m => m.id !== mesaId);
                guardarMesas();
                renderMesas();
            }
        }

        // Agregar nueva mesa
        function agregarMesa() {
            mesaCounter++;
            mesasData.push({
                id: mesaCounter,
                nombre: `Mesa ${mesaCounter}`,
                expanded: false,
                productos: []
            });
            guardarMesas();
            renderMesas();
        }

        // Editar nombre de mesa
        function editarNombreMesa(mesaId, nuevoNombre) {
            const mesa = mesasData.find(m => m.id === mesaId);
            if (mesa) {
                mesa.nombre = nuevoNombre;
                guardarMesas();
            }
        }

        // Toggle expandir mesa
        function toggleExpandMesa(mesaId) {
            const mesa = mesasData.find(m => m.id === mesaId);
            if (mesa) {
                mesa.expanded = !mesa.expanded;
                renderMesas();
            }
        }

        // Buscar productos en mesa
        async function buscarProductoMesa(mesaId, termino) {
            if (!termino || termino.length < 2) return;

            const inputBuscar = document.getElementById(`buscar-${mesaId}`);
            const listaSugerencias = document.getElementById(`sugerencias-${mesaId}`);

            try {
                const { data: productos, error } = await supabase
                    .from('productos')
                    .select('producto_id, codigo, producto, precio_venta, tipo_venta, unidad_venta')
                    .eq('tenant_id', userData.tenant_id)
                    .eq('activo', true)
                    .or(`producto.ilike.%${termino}%,codigo.ilike.%${termino}%`)
                    .limit(5);

                if (error) throw error;

                if (productos.length === 0) {
                    listaSugerencias.innerHTML = '<div style="padding: 10px; color: #999;">No se encontraron productos</div>';
                    listaSugerencias.style.display = 'block';
                    return;
                }

                listaSugerencias.innerHTML = productos.map(p => `
            <div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;" 
                 onmouseover="this.style.background='#f5f7ff'" 
                 onmouseout="this.style.background='white'"
                 onclick="agregarProductoAMesa(${mesaId}, ${p.producto_id}, '${p.codigo}', '${p.producto.replace(/'/g, "\\'")}', ${p.precio_venta}, '${p.tipo_venta}', '${p.unidad_venta}')">
                <div style="font-weight: 600;">[${p.codigo}] ${p.producto}</div>
                <div style="font-size: 11px; color: #666;">${formatPrecioMesa(p.precio_venta)}</div>
            </div>
        `).join('');

                listaSugerencias.style.display = 'block';

            } catch (error) {
                console.error('Error buscando productos:', error);
            }
        }

        // Agregar producto a mesa
        function agregarProductoAMesa(mesaId, productoId, codigo, nombre, precioUnitario, tipoVenta, unidadVenta) {
            const mesa = mesasData.find(m => m.id === mesaId);
            const cantidadInput = document.getElementById(`cantidad-${mesaId}`);
            const cantidad = parseFloat(cantidadInput.value) || 1;

            // Verificar si el producto ya existe en la mesa
            const productoExistente = mesa.productos.find(p => p.producto_id === productoId);

            if (productoExistente) {
                // Incrementar cantidad
                productoExistente.cantidad += cantidad;
                productoExistente.precio_total = productoExistente.precio_unitario * productoExistente.cantidad;
            } else {
                // Agregar nuevo producto
                mesa.productos.push({
                    producto_id: productoId,
                    codigo: codigo,
                    nombre: nombre,
                    cantidad: cantidad,
                    unidad: unidadVenta || 'und',
                    precio_unitario: precioUnitario,
                    precio_total: precioUnitario * cantidad
                });
            }

            // Limpiar b√∫squeda
            document.getElementById(`buscar-${mesaId}`).value = '';
            document.getElementById(`sugerencias-${mesaId}`).style.display = 'none';
            cantidadInput.value = '1';

            guardarMesas();
            renderMesas();
        }

        // Cambiar cantidad de b√∫squeda
        function cambiarCantidadBusqueda(mesaId, delta) {
            const input = document.getElementById(`cantidad-${mesaId}`);
            const nuevaCantidad = Math.max(0.01, (parseFloat(input.value) || 1) + delta);
            input.value = nuevaCantidad.toFixed(2).replace(/\.?0+$/, '');
        }

        // Toggle grabaci√≥n de voz para mesa
        async function toggleGrabacionMesa(mesaId) {
            if (grabacionActivaMesas && mesaGrabandoId === mesaId) {
                detenerGrabacionMesa(mesaId);
            } else if (!grabacionActivaMesas) {
                iniciarGrabacionMesa(mesaId);
            }
        }

        // Iniciar grabaci√≥n
        async function iniciarGrabacionMesa(mesaId) {
            const btnMic = document.getElementById(`mic-${mesaId}`);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorderMesas = new MediaRecorder(stream);
                audioChunksMesas = [];

                mediaRecorderMesas.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunksMesas.push(event.data);
                    }
                };

                mediaRecorderMesas.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());

                    if (audioChunksMesas.length > 0) {
                        const audioBlob = new Blob(audioChunksMesas, { type: 'audio/webm' });
                        if (audioBlob.size > 1000) {
                            await enviarAudioMesa(mesaId, audioBlob);
                        }
                    }

                    audioChunksMesas = [];
                };

                mediaRecorderMesas.start();
                grabacionActivaMesas = true;
                mesaGrabandoId = mesaId;

                btnMic.classList.add('recording');
                btnMic.innerHTML = '‚èπÔ∏è';

            } catch (error) {
                console.error('Error accediendo al micr√≥fono:', error);
                alert('No se pudo acceder al micr√≥fono');
            }
        }

        // Detener grabaci√≥n
        function detenerGrabacionMesa(mesaId) {
            if (mediaRecorderMesas && mediaRecorderMesas.state === 'recording') {
                mediaRecorderMesas.stop();
            }

            grabacionActivaMesas = false;
            mesaGrabandoId = null;

            const btnMic = document.getElementById(`mic-${mesaId}`);
            if (btnMic) {
                btnMic.classList.remove('recording');
                btnMic.innerHTML = 'üé§';
            }
        }

        // Enviar audio al webhook
        async function enviarAudioMesa(mesaId, audioBlob) {
            const mesa = mesasData.find(m => m.id === mesaId);

            try {
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1];

                    const response = await fetch('https://n8n-n8n.aa7tej.easypanel.host/webhook/productos-mesas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            audio: base64Audio,
                            tipo: 'audio',
                            mesa_id: mesaId,
                            mesa_nombre: mesa.nombre,
                            tenant_id: userData.tenant_id,
                            user_id: userData.user_id
                        })
                    });

                    const data = await response.json();

                    if (data.productos && Array.isArray(data.productos)) {
                        // Agregar productos reconocidos a la mesa
                        data.productos.forEach(p => {
                            agregarProductoAMesa(
                                mesaId,
                                p.producto_id,
                                p.codigo,
                                p.nombre,
                                p.precio,
                                p.tipo_venta,
                                p.unidad_venta
                            );
                        });
                    }
                };

            } catch (error) {
                console.error('Error enviando audio:', error);
                alert('Error al procesar el audio');
            }
        }

        // Registrar venta de mesa
        async function registrarVentaMesa(mesaId) {
            const mesa = mesasData.find(m => m.id === mesaId);

            if (mesa.productos.length === 0) {
                alert('La mesa no tiene productos');
                return;
            }

            const total = calcularTotalMesa(mesa.productos);

            if (!confirm(`¬øConfirmar venta de ${mesa.nombre} por ${formatPrecioMesa(total)}?`)) {
                return;
            }

            try {
                // Enviar al webhook del chat asistente
                const response = await fetch('https://n8n-n8n.aa7tej.easypanel.host/webhook/chat-panel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tipo: 'venta_mesa',
                        mesa_nombre: mesa.nombre,
                        productos: mesa.productos,
                        total: total,
                        usuario: userData.nombre,
                        tenant_id: userData.tenant_id,
                        user_id: userData.user_id
                    })
                });

                const data = await response.json();

                if (data.exito) {
                    alert(`‚úÖ Venta registrada: ${formatPrecioMesa(total)}`);
                    // Limpiar mesa
                    mesa.productos = [];
                    guardarMesas();
                    renderMesas();
                } else {
                    throw new Error(data.error || 'Error al registrar venta');
                }

            } catch (error) {
                console.error('Error registrando venta:', error);
                alert('Error al registrar la venta: ' + error.message);
            }
        }

        function renderMesas() {
            const container = document.getElementById('mesasGrid');
            container.innerHTML = '';

            // Detectar si es mobile
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // VISTA MOBILE - Lista vertical
                let totalOcupadas = 0;

                mesasData.forEach(mesa => {
                    const total = calcularTotalMesa(mesa.productos);
                    const tieneProductos = mesa.productos.length > 0;

                    if (tieneProductos) {
                        totalOcupadas += total;
                    }

                    const estadoClass = tieneProductos ? 'ocupada' : 'disponible';
                    const estadoTexto = tieneProductos ? 'Ocupada' : 'Disponible';

                    const mesaCard = document.createElement('div');
                    mesaCard.className = `mesa-card ${estadoClass}`;
                    mesaCard.onclick = () => abrirDetalleMesa(mesa.id);
                    mesaCard.innerHTML = `
    <div class="mesa-header">
        <div class="mesa-title-wrapper">
            <div class="mesa-title-input">${mesa.nombre}</div>
        </div>
        <div class="mesa-estado-badge">${estadoTexto}</div>
    </div>
    <div class="mesa-info-mobile">
        <div class="mesa-total-badge">${formatPrecioMesa(total)}</div>
    </div>
`;

                    container.appendChild(mesaCard);
                });

                // Resumen total de mesas ocupadas (solo si hay mesas ocupadas)
                if (totalOcupadas > 0) {
                    const resumen = document.createElement('div');
                    resumen.className = 'resumen-mesas-mobile';
                    resumen.innerHTML = `
                <div class="label">TOTAL MESAS OCUPADAS</div>
                <div class="total">${formatPrecioMesa(totalOcupadas)}</div>
            `;
                    container.appendChild(resumen);
                }

                // Bot√≥n agregar nueva mesa
                const addCard = document.createElement('div');
                addCard.className = 'add-mesa-card';
                addCard.onclick = agregarMesa;
                addCard.innerHTML = '<div class="add-icon-mesa">+</div>';
                container.appendChild(addCard);

            } else {
                // VISTA DESKTOP - Grid original
                mesasData.forEach(mesa => {
                    const total = calcularTotalMesa(mesa.productos);
                    const tieneProductos = mesa.productos.length > 0;
                    const wrapperSizeClass = mesa.expanded ? 'size-expanded' : 'size-default';

                    const expandIcon = mesa.expanded
                        ? `<line x1="21" y1="3" x2="3" y2="21"></line>
                   <polyline points="15 3 3 3 3 15"></polyline>
                   <polyline points="9 21 21 21 21 9"></polyline>`
                        : `<polyline points="15 3 21 3 21 9"></polyline>
                   <polyline points="9 21 3 21 3 15"></polyline>
                   <line x1="21" y1="3" x2="3" y2="21"></line>`;

                    const closeBtnHTML = !tieneProductos
                        ? `<button class="close-mesa-btn" onclick="eliminarMesa(${mesa.id})" title="Eliminar mesa">
                    <svg class="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>`
                        : '';

                    const mesaCard = document.createElement('div');
                    mesaCard.className = 'mesa-card';
                    mesaCard.innerHTML = `
                <div class="mesa-header">
                    <div class="mesa-title-wrapper">
                        <input type="text" 
                               class="mesa-title-input" 
                               value="${mesa.nombre}" 
                               onchange="editarNombreMesa(${mesa.id}, this.value)">
                    </div>
                    <div class="header-actions">
                        <button class="expand-btn" onclick="toggleExpandMesa(${mesa.id})">
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                ${expandIcon}
                            </svg>
                        </button>
                        ${closeBtnHTML}
                    </div>
                </div>
                
                <div class="productos-container-mesa">
                    <div class="productos-wrapper-mesa ${wrapperSizeClass}">
                        <table class="productos-table-mesa">
                            <tbody>
                                ${mesa.productos.map((p, idx) => `
                                    <tr class="producto-row-mesa">
                                        <td>
                                            <div class="cantidad-control-mesa">
                                                <button class="cantidad-btn-mesa" onclick="cambiarCantidadMesa(${mesa.id}, ${idx}, -1)">‚àí</button>
                                                <span class="cantidad-display-mesa">${p.cantidad}</span>
                                                <button class="cantidad-btn-mesa" onclick="cambiarCantidadMesa(${mesa.id}, ${idx}, 1)">+</button>
                                            </div>
                                        </td>
                                        <td>${p.unidad}</td>
                                        <td>${p.nombre}</td>
                                        <td>${formatPrecioMesa(p.precio_total)}</td>
                                        <td>
                                            <button class="delete-producto-mesa-btn" onclick="eliminarProductoMesa(${mesa.id}, ${idx})">
                                                <svg class="trash-icon-mesa" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="3 6 5 6 21 6"></polyline>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="total-section-mesa">
                        <span>Total</span>
                        <span class="total-amount-mesa">${formatPrecioMesa(total)}</span>
                    </div>
                    
                    <div class="buscar-section-mesa">
                        <div class="cantidad-buscar-mesa">
                            <button class="cantidad-btn-mesa" onclick="cambiarCantidadBusqueda(${mesa.id}, -1)">‚àí</button>
                            <input type="number" id="cantidad-${mesa.id}" value="1" min="0.01" step="0.01" style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                            <button class="cantidad-btn-mesa" onclick="cambiarCantidadBusqueda(${mesa.id}, 1)">+</button>
                        </div>
                        <input type="text" id="buscar-${mesa.id}" class="buscar-input-mesa" placeholder="Buscar producto..." oninput="buscarProductoMesa(${mesa.id}, this.value)">
                        <button id="mic-${mesa.id}" class="mic-btn-mesa" onclick="toggleGrabacionMesa(${mesa.id})">üé§</button>
                        <div id="sugerencias-${mesa.id}" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 100; width: calc(100% - 40px); margin-top: 2px;"></div>
                    </div>
                    
                    <button class="registrar-venta-mesa-btn" onclick="registrarVentaMesa(${mesa.id})">Registrar Venta</button>
                </div>
            `;

                    container.appendChild(mesaCard);
                });

                // Agregar bot√≥n para nueva mesa
                const addCard = document.createElement('div');
                addCard.className = 'add-mesa-card';
                addCard.onclick = agregarMesa;
                addCard.innerHTML = '<div class="add-icon-mesa">+</div>';
                container.appendChild(addCard);
            }
        }

        // Abrir detalle de mesa en mobile
        function abrirDetalleMesa(mesaId) {
            const isMobile = window.innerWidth < 768;
            if (!isMobile) return; // Solo funciona en mobile

            const mesa = mesasData.find(m => m.id === mesaId);
            const container = document.getElementById('mesasGrid');

            // Renderizar vista detalle
            container.innerHTML = `
        <div style="padding: 16px;">
            <button onclick="renderMesas()" style="background: rgba(255,255,255,0.1); border: 2px solid white; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                ‚Üê Volver
            </button>
            
            <div class="mesa-card" style="border: 2px solid #10b981;">
                <!-- Aqu√≠ va todo el contenido actual de la mesa card desktop -->
            </div>
        </div>
    `;

            // Copiar el HTML de la mesa card actual (desktop) dentro del div
            const tempContainer = document.createElement('div');
            renderMesas(); // Renderizar temporalmente para obtener el HTML
            const desktopCard = Array.from(document.querySelectorAll('.mesa-card')).find(card =>
                card.querySelector(`input[value="${mesa.nombre}"]`)
            );

            if (desktopCard) {
                container.querySelector('.mesa-card').innerHTML = desktopCard.innerHTML;
            }
        }

    </script>
</body>

<!-- Modal Crear Producto -->
<div id="modalCrearProducto" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üì¶ Crear Producto</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Aqu√≠ se cargar√° el formulario -->
        </div>
    </div>
</div>

<!-- Modal Registrar Compra -->
<div id="modalRegistrarCompra" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üõí Registrar Compra</h3>
            <button class="modal-close" onclick="closeModalCompra()">√ó</button>
        </div>
        <div class="modal-body" id="modalBodyCompra">
            <!-- Aqu√≠ se cargar√° el formulario -->
        </div>
    </div>
</div>

<!-- Modal Crear Usuario -->
<div id="modalCrearUsuario" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üë§ Crear Usuario</h3>
            <button class="modal-close" onclick="closeModalUsuario()">√ó</button>
        </div>
        <div class="modal-body" id="modalBodyUsuario">
            <!-- Aqu√≠ se cargar√° el formulario -->
        </div>
    </div>
</div>

<!-- Modal Informes -->
<div id="modalInformes" class="modal">
    <div class="modal-content modal-informes">
        <div class="modal-header">
            <h3>üìä Informes y Estad√≠sticas</h3>
            <button class="modal-close" onclick="closeModalInformes()">√ó</button>
        </div>
        <div class="modal-body" id="modalBodyInformes">
            <!-- Aqu√≠ se cargar√°n los informes -->
        </div>
    </div>
</div>

<!-- Modal Editar Producto -->
<div id="modalEditarProducto" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Producto</h3>
            <button class="modal-close" onclick="closeModalEditarProducto()">√ó</button>
        </div>
        <div class="modal-body" id="modalBodyEditarProducto">
            <!-- Aqu√≠ se cargar√° el formulario -->
        </div>
    </div>
</div>

<!-- Modal Editar Apodos -->
<div id="modalEditarApodos" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üè∑Ô∏è Editar Apodos</h3>
            <button class="modal-close" onclick="closeModalEditarApodos()">√ó</button>
        </div>
        <div class="modal-body" id="modalBodyEditarApodos">
            <!-- Aqu√≠ se cargar√° el formulario -->
        </div>
    </div>
</div>

<!-- Modal Editor de Apodos Individual -->
<div id="modalEditorApodos" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tituloModalEditorApodos">üè∑Ô∏è Editar Apodos</h3>
            <button class="modal-close" onclick="cerrarModalEditorApodos()">√ó</button>
        </div>
        <div class="modal-body" id="modalBodyEditorApodos">
            <!-- Aqu√≠ se cargar√° el editor de apodos -->
        </div>
    </div>
</div>

<!-- Modal Chat Asistente -->
<div id="modalChatAsistente" class="modal">
    <div class="modal-content"
        style="max-width: 100%; width: 100%; height: 100%; max-height: 100vh; margin: 0; border-radius: 0; display: flex; flex-direction: column;">
        <!-- Header -->
        <div
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div
                    style="width: 40px; height: 40px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                    üí¨
                </div>
                <div>
                    <div style="font-weight: 600; font-size: 16px;">Chat Asistente</div>
                    <div style="font-size: 12px; opacity: 0.9;">En l√≠nea</div>
                </div>
            </div>
            <button onclick="closeModalChat()"
                style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; min-width: auto; transition: background 0.2s; flex-shrink: 0;">
                √ó
            </button>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">
            <!-- √Årea de mensajes -->
            <div id="chatMessages"
                style="flex: 1; overflow-y: auto; padding: 12px; background: #e5ddd5; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
            </div>

            <!-- √Årea de input -->
            <div
                style="padding: 8px 12px; background: #f0f0f0; border-top: 1px solid #d1d1d1; flex-shrink: 0; position: sticky; bottom: 0; z-index: 100;">
                <div style="display: flex; gap: 8px; align-items: flex-end;">

                    <!-- Input con clip dentro -->
                    <div
                        style="flex: 1; display: flex; align-items: center; background: white; border-radius: 22px; padding: 8px 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); min-height: 44px;">
                        <input type="text" id="inputMensajeChat" placeholder="Mensaje"
                            style="flex: 1; border: none; font-size: 15px; background: transparent; outline: none; padding: 6px 4px; margin: 0; min-height: 28px; width: 100%;"
                            onkeypress="if(event.key === 'Enter') { event.preventDefault(); enviarMensajeChat(); }"
                            oninput="toggleInputButtons()">

                        <!-- Bot√≥n clip DENTRO del input -->
                        <input type="file" id="inputImagenChat" accept="image/*" style="display: none;"
                            onchange="handleImageUpload(event)">
                        <button onclick="document.getElementById('inputImagenChat').click()"
                            style="padding: 0; margin: 0 0 0 4px; background: none; border: none; cursor: pointer; color: #999; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: color 0.2s; width: 32px; min-width: 32px; height: 32px; flex-shrink: 0;"
                            ontouchstart="this.style.background='#f0f0f0'" ontouchend="this.style.background='none'">
                            üìé
                        </button>
                    </div>

                    <!-- Bot√≥n micr√≥fono (visible cuando input vac√≠o) -->
                    <button id="btnGrabarVoz"
                        style="min-width: 44px; width: 44px; height: 44px; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3); transition: transform 0.1s, box-shadow 0.1s; touch-action: none; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;">
                        üé§
                    </button>

                    <!-- Bot√≥n enviar (oculto inicialmente) -->
                    <button id="btnEnviarMensaje" onclick="enviarMensajeChat()"
                        style="min-width: 48px; width: 48px; height: 48px; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3); transition: transform 0.1s;"
                        ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">
                        ‚û§
                    </button>
                </div>
                <div id="estadoGrabacion"
                    style="display: none; margin-top: 8px; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center; color: white; font-size: 12px; font-weight: 600;">
                    üé§ Mant√©n presionado para grabar...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Mesas -->
<div id="modalMesas" class="modal">
    <div class="modal-content"
        style="max-width: 100%; width: 100%; height: 100vh; max-height: 100vh; margin: 0; border-radius: 0; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3>üçΩÔ∏è Gesti√≥n de Mesas</h3>
            <button class="modal-close" onclick="closeModalMesas()">√ó</button>
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 0;">
            <div id="mesasGrid" class="mesas-grid"></div>
        </div>
    </div>
</div>

</html>
